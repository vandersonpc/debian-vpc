(self.webpackChunk=self.webpackChunk||[]).push([[4382],{20702:(e,t,i)=>{i.r(t),i.d(t,{CheetahFeatureImpl:()=>Et,isAssistantOpened:()=>Ut});var s=i(17771),a=i(17889),n=i(62965),r=i(6294),o=i(85892),l=i(57050),d=i(27378),h=i(54696),c=i(57757),p=i(55649),u=i(98805),g=i(14601),m=i(32952),v=i(60797),_=i(66310),b=i(24209),S=i(85985),f=i(23063),y=i(40151),w=i(98403),A=i(2844),I=i(77176),x=i(2834),R=i(76974),C=i(28043),U=i(93508),E=i(16118),k=i(13444),B=i(78674),P=i(12126),T=i(17343),O=i(80544),z=i(79692),M=i(67434),G=i(19751),H=i(44586),N=i(97425),F=i(5114),D=i(8125),j=i(83078),W=i(95195),q=i(22232),V=i(54001),$=i(23239),L=i(34217),Z=i(51325);const Q=({width:e,height:t,top:i,left:s,visibility:a})=>d.createElement("div",{"data-grammarly-part":"cheetah-highlight-rect",...(0,V.Sh)(Z.highlightRect,"hidden"===a?Z.hidden:null,"attention"===a?Z.attention:null),style:{width:e,height:t,top:i,left:s}});var Y=i(6726),K=i(16805);const J=d.forwardRef((function({forceTooltipMessage:e,onClick:t,onMouseEnter:i,onMouseLeave:s},a){return d.createElement(Y.u,{message:"Open GrammarlyGO",forcedMessage:e},d.createElement("button",{onClick:t,"data-grammarly-part":"cheetah-ideate-button",className:K.ideateButton,ref:a,onMouseEnter:i,onMouseLeave:s},d.createElement("div",{className:K.ideateButtonIcon})))}));var X=i(88571),ee=i(4147),te=i(89894),ie=i(15073),se=i(42103),ae=i(51369),ne=i(85665);const re=te.ux.style({fontStyle:"normal",fontWeight:"normal",fontFamily:"Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif, Arial",$nest:{"button, input, textarea":{fontFamily:"inherit"}}}),oe=({children:e})=>{var t;const i=null===(t=d.useContext(ne.nS.Context))||void 0===t?void 0:t.host;return d.createElement(ee.o,null,d.createElement(X.Q,{remSize:R.of(16),setter:e=>ie.u.setRootCssVar(i||document.documentElement,e)},d.createElement(se.G.DefaultProvider,null,d.createElement("div",{className:re},e,d.createElement(ae.X,null)))))};var le=i(37869),de=i(50783);const he=({referenceElement:e,placement:t,offset:i,disabled:s,onClick:a})=>{const[n,r]=d.useState(null),{styles:o,attributes:l}=(0,le.D)(e,n,{placement:t,modifiers:i?[{name:"offset",options:{offset:i}}]:[]});return d.createElement("button",{ref:r,style:o.popper,...l.popper,onClick:a,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},"data-grammarly-part":"cheetah-reply-button",className:de.replyButton,"data-disabled":s},d.createElement("div",{className:de.icon}),d.createElement("span",null,"Reply quickly"))};var ce=i(87491);const pe=({referenceElement:e,placement:t,offset:i,disabled:s,onMagicRewriteClick:a,onOpenRewriteClick:n})=>{const[r,o]=d.useState(null),{styles:l,attributes:h}=(0,le.D)(e,r,{placement:t,modifiers:i?[{name:"offset",options:{offset:i}}]:[]});return a||n?d.createElement("div",{ref:o,style:l.popper,...h.popper,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},"data-grammarly-part":"cheetah-entry-button",className:ce.entryButton,"data-disabled":s},a?d.createElement(Y.u,{message:"Improve it"},d.createElement("button",{onClick:a,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},className:ce.entryButtonItem,"data-disabled":s},d.createElement("i",{className:ce.rewriteIcon}))):null,n?d.createElement(Y.u,{message:"Open GrammarlyGO"},d.createElement("button",{onClick:n,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},className:ce.entryButtonItem,"data-disabled":s},d.createElement("i",{className:ce.openIcon}))):null):null};var ue=i(90845),ge=i(49708),me=i(8543),ve=i(48033);const _e=()=>d.createElement("svg",{className:ve.icon,viewBox:"0 0 16 16",fillRule:"evenodd",clipRule:"evenodd",strokeLinecap:"round"},d.createElement("path",{d:"M8,16C12.418,16 16,12.418 16,8C16,3.582 12.418,0 8,0C3.582,0 0,3.582 0,8C0,12.418 3.582,16 8,16Z",fill:"#0A9A78"}),d.createElement("path",{d:"M4,8L12,8M8,4L8,12",fill:"none",fillRule:"nonzero",stroke:"white",strokeWidth:"1.5px"})),be=({overflow:e,...t})=>e?d.createElement(fe,{...t}):d.createElement(Se,{...t}),Se=({left:e,top:t,height:i})=>d.createElement(d.Fragment,null,d.createElement("div",{"data-grammarly-part":"cheetah-quasi-caret",className:ve.quasiCaret,style:{left:e,top:t+i,height:i+8}},d.createElement(_e,null))),fe=({left:e,top:t,height:i})=>{const{ref:a,onMount:n}=ue.P.useElWatcher(),r=d.useMemo((()=>$.h.create(F.none)),[]),{rect:o,onMount:h}=ue.P.useRectWatcher(),c=d.useCallback((e=>{e.style.pointerEvents="all",r.set((0,l.zG)(s.Y(F.option)({rect:F.some(e.getBoundingClientRect()),goodParent:(0,l.zG)(e.getBoundingClientRect(),(e=>({x:e.x+e.width/2,y:e.y+e.height/2})),(({x:e,y:t})=>{var i,s;return F.fromNullable(null===(s=null===(i=document.elementFromPoint(e,t))||void 0===i?void 0:i.shadowRoot)||void 0===s?void 0:s.elementFromPoint(e,t))}),F.filter((t=>t===e||e.contains(t||null))))}),F.fold((()=>F.none),(({rect:e})=>F.some({x:e.x,y:e.y}))))),e.style.pointerEvents="none"}),[]),p=d.useMemo((()=>ge.R(document,"scroll",{capture:!0}).pipe(U.O(null))),[]);return ue.P.useSubscriptionTo(A.aj([a.pipe(v.oA),p,o]).pipe(x.b((([e])=>c(e))))),d.createElement(d.Fragment,null,d.createElement("div",{"data-grammarly-part":"cheetah-quasi-caret",className:ve.quasiCaret,style:{left:e,top:t+i,height:i+8},ref:e=>{n(e),h(e)}},d.createElement(me.F.div,{style:r.pipe(I.U((e=>(0,l.zG)(e,F.fold((()=>({opacity:1})),(()=>({opacity:0})))))))},d.createElement(_e,null))),d.createElement(me.F.Fragment,null,r.pipe(I.U((e=>(0,l.zG)(e,F.fold(l.gn,(e=>d.createElement("div",{"data-grammarly-part":"cheetah-quasi-caret-fixed-bro",className:ve.quasiCaret,style:{transform:"none",position:"fixed",left:e.x,top:e.y,height:i+8}},d.createElement(_e,null))))))))))};var ye=i(10389),we=i(64015),Ae=i(12422),Ie=i(819),xe=i(50901),Re=i(51478),Ce=i(69693),Ue=i(94175),Ee=i(20154),ke=i(66768),Be=i(82471),Pe=i(43254),Te=i(84403),Oe=i(42724),ze=i(92627),Me=i(99877),Ge=i(44848),He=i(72004),Ne=i(36847),Fe=i(35298),De=i(29972),je=i(51129),We=i(7534);var qe=i(44358),Ve=i(81873),$e=i(81531),Le=i(65504),Ze=i(9205),Qe=i(9629),Ye=i(88355),Ke=i(4068),Je=i(30857),Xe=i(31528);function et(e){return"pushAssistantFeed"===e.type}function tt(e){var t,i;const s="pushRewrite"===e.mode?null:e,a=((null===(t=null==s?void 0:s.source)||void 0===t?void 0:t.type)===Xe.WT.sdui?s.source.action.actions:[]).find((0,D.W9)(et,(e=>"default-feed"===e.feedId)));return{feedId:"default-feed",cardId:null!==(i=null==a?void 0:a.cardId)&&void 0!==i?i:null}}function it(e,t,i,s){switch(e.mode){case"ideation":return{mode:e.mode,metadata:t,documentUrl:s};case"rewrite":case"quickRewrite":return{mode:e.mode,metadata:t};case"quickReply":return{mode:e.mode,quickReplyContext:(0,l.zG)(i,F.fold((()=>Ke.H.empty),st)),metadata:t};case"pushRewrite":return{mode:e.mode,writingExpertContext:e.writingExpertContext};default:(0,q.L0)(e)}}function st(e){var t,i,s,a,n,r,o,d,h,c,p,u,g,m,v,_,b;const S=e=>{var t;return null!==(t=null==e?void 0:e.reduce(((e,t)=>{var i;return t.email&&!e.has(t.email)&&e.set(t.email,{name:null!==(i=t.name)&&void 0!==i?i:"",email:t.email}),e}),new Map))&&void 0!==t?t:new Map},f=S(null===(s=null===(i=null===(t=e.parents)||void 0===t?void 0:t[0])||void 0===i?void 0:i.audience)||void 0===s?void 0:s.indirectRecipients),y=S(null===(r=null===(n=null===(a=e.parents)||void 0===a?void 0:a[0])||void 0===n?void 0:n.audience)||void 0===r?void 0:r.undisclosedRecipients),w=S(null===(c=null===(h=null===(d=null===(o=e.parents)||void 0===o?void 0:o[0])||void 0===d?void 0:d.audience)||void 0===h?void 0:h.recipients)||void 0===c?void 0:c.filter((({email:e})=>(0,Je.HD)(e)&&!f.has(e)&&!y.has(e)))),A=S(null===(p=e.audience)||void 0===p?void 0:p.indirectRecipients),I=S(null===(u=e.audience)||void 0===u?void 0:u.undisclosedRecipients),x=S(null===(m=null===(g=e.audience)||void 0===g?void 0:g.recipients)||void 0===m?void 0:m.filter((({email:e})=>(0,Je.HD)(e)&&!A.has(e)&&!I.has(e))));return{previousMessageInfo:(0,l.zG)(we.YM(null!==(v=e.parents)&&void 0!==v?v:[]),F.fold((()=>Ke.H.PreviousMessageInfo.empty),(e=>{var t;return{author:(0,l.zG)(we.YM(null!==(t=e.authors)&&void 0!==t?t:[]),F.fold((()=>Ke.H.Person.empty),(e=>{var t,i;return{name:null!==(t=e.name)&&void 0!==t?t:"",email:null!==(i=e.email)&&void 0!==i?i:""}}))),directRecipients:Array.from(w.values()),text:e.delta?(0,Ye.l)(e.delta,""):""}}))),title:null!==(_=e.title)&&void 0!==_?_:"",author:(0,l.zG)(we.YM(null!==(b=e.authors)&&void 0!==b?b:[]),F.fold((()=>Ke.H.Person.empty),(e=>{var t,i;return{name:null!==(t=e.name)&&void 0!==t?t:"",email:null!==(i=e.email)&&void 0!==i?i:""}}))),directRecipients:Array.from(x.values()),indirectRecipients:Array.from(A.values()),undisclosedRecipients:Array.from(I.values())}}var at=i(41127),nt=i(8709),rt=i(20236),ot=i(67534);function lt(e,t,i,s){const{left:a,right:n}=(0,l.zG)(e,we.UI((({alertId:e,alternativeIndex:i})=>function(e,t,i){return(0,l.zG)(W.fromOption((()=>`Alert ${e} not found`))(i(e)),W.filterOrElse(rt.S.isCapiAlert,(t=>`Unsupported alert ${e} with type ${t._tag}`)),W.chain((i=>h.$.isWithTransformJson(i)?(0,l.zG)(i.transformJSON.alternatives,F.chain((e=>{var i;return F.fromNullable(null===(i=e.alternatives[t])||void 0===i?void 0:i.delta)})),W.fromOption((()=>`Alternative ${t} not found for WithTransformJson alert ${e}`))):h.$.isWithSubAlerts(i)?(0,l.zG)(i.subalerts.alternatives,F.chain((e=>{var i;return F.fromNullable(null===(i=e.alternatives[t])||void 0===i?void 0:i.delta)})),W.fromOption((()=>`Alternative ${t} or context not found for WithSubAlerts alert ${e}`))):h.$.isWithPosition(i)?W.right((new nt.i).retain(i.transformRange.start).delete(i.transformRange.end-i.transformRange.start).insert(i.transformText)):W.left(`Unsupported alert ${e}`))),W.map((i=>({delta:i,alertId:e,alternativeIndex:t}))))}(e,i,t))),we.oh),r=n.reduce(((e,t)=>e.compose(t.delta)),new nt.i),o=(0,ot.g)(r),d=(0,ot.B)(r);return i.performBatchReplacements(o).then((()=>W.right(void 0))).catch((t=>W.left(`Replacement error for [${e.map((e=>`alertId: ${e.alertId} altIdx: ${e.alternativeIndex}`)).join(", ")}]: `+String(t)))).then((e=>(0,l.zG)(s(),F.filter((()=>d.length>0)),F.fold((()=>Promise.resolve(W.right(void 0))),(e=>Promise.all(d.map((({range:t,formatting:i})=>e.apply(t,i).then((()=>W.right(void 0))).catch((e=>W.left(String(e))))))).then((0,l.ls)(we.oh,(({left:e})=>e.length>0?W.left(`Formatting errors [${e.join(", ")}]`):W.right(void 0))))))).then((t=>{const i=a.concat(W.isLeft(e)?[e.left]:[]).concat(W.isLeft(t)?[t.left]:[]);return i.length>0?W.left(new Error(`AlertApply - ${i.join(" - ")}`)):W.right(void 0)}))))}var dt=i(80358),ht=i(36919),ct=i(19125);var pt=i(71078),ut=i(18625);var gt=i(48015);function mt(e){return i.e(8661).then(i.bind(i,19853)).then((({createRevisionEngine:t})=>{const i=$.h.create(null),s=e.alertStateService.getActiveAlertByClick().pipe(I.U((e=>{var t;return null!==(t=null==e?void 0:e.alertId)&&void 0!==t?t:null}))).subscribe(w.wW(i)),a=p.Y.create("cheetah.revision"),{revisionEngine:n,dispose:r}=t({capiService:e.capiService,sduiService:{sduiItemCollectionChanges:(d=e.sduiBufferService,b.T(d.pipe(E.G(),I.U((([e,t])=>F.isSome(e)?F.some((0,ct.ex)()):F.none)),v.oA),d.pipe(_.w(F.fold((()=>y.E),(e=>e.capiEvents.pipe(S.h((0,D.Kg)(dt.h.is("sdui_add"),dt.h.is("sdui_update"),dt.h.is("sdui_remove"))),I.U((e=>{switch(e.kind){case"sdui_add":return(0,ct.K5)(e.sduiRootId,e.sdui);case"sdui_update":return(0,ct.FE)(e.sduiRootId,e.sdui);case"sdui_remove":return(0,ct.Ul)(e.sduiRootId);default:return(0,l.Rz)(e)}})))))))).pipe((e=>e.pipe(ht.f(e.pipe(B.b(0))))),S.h((e=>e.length>0)))).pipe(x.b((e=>a.trace("sduiService.sduiItemCollectionChanges",e)))),initialFeed:e.initialFeed},alertService:{alertCollectionChanges:(o=e.alertProcessor.alerts,ut.P((()=>o.changes.pipe(I.U((e=>{const t=new Set(e.addedAlerts.filter(rt.S.isCapiAlert).map((e=>e.id))),i=new Set(e.removedAlerts.filter((e=>rt.S.isCapiAlert(e.alert))).map((e=>e.id)));return[...e.addedAlerts.filter(rt.S.isCapiAlert).filter((e=>!i.has(e.id))).map((e=>(0,pt.Tm)(e.id))),...e.removedAlerts.filter((e=>rt.S.isCapiAlert(e.alert))).filter((e=>!t.has(e.id))).map((e=>(0,pt.qQ)(e.id,"textChange"===e.reason._tag?"textChange":"other")))]})),U.O(Array.from(o.getAll()).filter(rt.S.isCapiAlert).map((e=>(0,pt.Tm)(e.id)))),(e=>e.pipe(ht.f(e.pipe(B.b(0))))),I.U((e=>e.flatMap(l.yR))),S.h((e=>e.length>0)))))).pipe(x.b((e=>a.trace("alertService.alertCollectionChange",e)))),selectedAlertId:i,applyAlerts:t=>{const i=lt(t,(t=>F.fromNullable(e.alertProcessor.alerts.getAlertById(t))),e.replacementService,e.getFormattingService).then(W.fold((e=>{throw a.warn("Error applying alerts",{applyAlertsInfo:t,error:e}),e}),(()=>{})));return e.requestAwaitService.addRequest(i),i},removeAlerts:t=>(0,gt.DV)((()=>Promise.resolve(t.forEach((({alertId:t,removalReason:i})=>{e.alertProcessor.removeAlert(t,{_tag:"alertApplied"===i?at.i.alertAccepted:at.i.ignore})})))),(e=>(a.warn("Error removing alerts",{removedAlertsInfo:t,error:e}),Promise.reject(e)))),setAlertsVisibility:t=>(e.highlightsUpdater.setAlertsVisibility(t),e.highlightsScroller.scrollToEmphasizedAlert(t,i.get()),Promise.resolve(void 0)),updateAlertsVisibility:t=>(e.highlightsUpdater.updateAlertsVisibility(t),e.highlightsScroller.scrollToEmphasizedAlert(t,i.get()),Promise.resolve(void 0))},monitoringService:{notify:t=>function(e,t,i,s){"error"===t.kind?e.cheetah.error(t,i,s):"warn"===t.kind?e.cheetah.warning(t,i,s):"info"===t.kind?e.cheetah.info(t,i,s):(0,q.L0)(t.kind)}(e.telemetry,t,e.domain,e.getSessionUuid())},logger:a});var o,d;return{revisionEngine:n,dispose:()=>{e.highlightsUpdater.clearAll(),s.unsubscribe(),r()}}}))}var vt=i(48044),_t=i(13853),bt=i(7604),St=i(73975),ft=i(95300),yt=i(32409);class wt{constructor(e){this._params=e,this._subs=new g.w,this._visibleAlertsSubject=new ft.X(new Map),this._emphasizedAlertsSubject=new ft.X(new Map),this._visibleAlerts=this._visibleAlertsSubject.pipe(G.skipBy(vt.Eh(St.yv,_t.Eh(St.yv)))),this._emphasizedAlerts=this._emphasizedAlertsSubject.pipe(G.skipBy(vt.Eh(St.yv,_t.Eh(St.yv)))),this.hasHighlights=this._visibleAlerts.pipe(I.U((e=>e.size>0)),U.O(!1),C.x(),G.shareReplay({bufferSize:1,refCount:!0})),this._subs.add(this._visibleAlerts.subscribe((e=>{var t;return null===(t=this._params.logger)||void 0===t?void 0:t.debug("visible highlights",e)}))),this._subs.add(this._emphasizedAlerts.subscribe((e=>{var t;return null===(t=this._params.logger)||void 0===t?void 0:t.debug("emphasized highlights",e)})))}setAlertsVisibility(e){this.clearAll();const t=new Map(this._visibleAlertsSubject.value),i=new Map(this._emphasizedAlertsSubject.value);e.filter((e=>"hidden"!==e.visibility)).forEach((({alertId:e,visibility:s})=>{const a=this._params.getAlertById(e);if(a){const n=a.highlightRanges.map((t=>({range:t,highlightId:At(e,t)})));n.forEach((({range:e,highlightId:t})=>{this._params.highlightCollection.addHighlight(t,e,yt.M.getHighlightMeta(a,t,e,!1))})),t.set(e,new Set(n.map((e=>e.highlightId)))),"emphasized"===s&&i.set(e,new Set(n.map((e=>e.highlightId))))}})),this._visibleAlertsSubject.next(t),this._emphasizedAlertsSubject.next(i)}updateAlertsVisibility(e){const t=new Map(this._visibleAlertsSubject.value),i=new Map(this._emphasizedAlertsSubject.value);e.forEach((({alertId:e,visibility:s})=>{var a;const n=this._params.getAlertById(e);if(n&&"hidden"!==s){const a=n.highlightRanges.map((t=>({range:t,highlightId:At(e,t)})));a.forEach((({range:e,highlightId:t})=>{this._params.highlightCollection.updateHighlight(t,e,yt.M.getHighlightMeta(n,t,e,!1))})),t.set(e,new Set(a.map((e=>e.highlightId)))),"emphasized"===s?i.set(e,new Set(a.map((e=>e.highlightId)))):i.delete(e)}else{const s=Array.from(null!==(a=this._visibleAlertsSubject.value.get(e))&&void 0!==a?a:new Set);s.length>0&&this._params.highlightCollection.removeHighlights(s),t.delete(e),i.delete(e)}})),this._visibleAlertsSubject.next(t),this._emphasizedAlertsSubject.next(i)}clearAll(){const e=new Set(Array.from(this._visibleAlertsSubject.value.values()).concat(Array.from(this._emphasizedAlertsSubject.value.values())).flatMap((e=>Array.from(e))));e.size>0&&this._params.highlightCollection.removeHighlights(Array.from(e)),this._visibleAlertsSubject.next(new Map),this._emphasizedAlertsSubject.next(new Map)}getHighlightVisualState(e){const t=this._params.alertStateService.getHighlightedAlert().pipe(I.U((t=>{var i;return!0===(null===(i=null==t?void 0:t.highlightIds)||void 0===i?void 0:i.includes(e))})),U.O(!1),C.x()),i=this._params.alertStateService.getActiveAlertByClick().pipe(I.U((t=>{var i;return!0===(null===(i=null==t?void 0:t.highlightIds)||void 0===i?void 0:i.includes(e))})),U.O(!1),C.x()),s=this._emphasizedAlerts.pipe(I.U((t=>Array.from(t.values()).some((t=>t.has(e))))),C.x());return A.aj([t,i,s]).pipe(I.U((([e,t,i])=>({hovered:e,selectedByClick:t,emphasized:i}))),U.O({hovered:!1,selectedByClick:!1,emphasized:!1}),E.G(),I.U((([e,t])=>t.hovered||t.selectedByClick?bt.pc.hovered:t.emphasized?e.hovered||e.selectedByClick?bt.pc.hovered:bt.pc.hoveredNeedsAttention:bt.pc.none)),U.O(bt.pc.none),C.x(),x.b((t=>{var i;return null===(i=this._params.logger)||void 0===i?void 0:i.debug(`[${e}] visual state:`,t)})))}dispose(){this.clearAll(),this._subs.unsubscribe()}}function At(e,t){return`${e}|${t.start}-${t.end}|cheetah`}class It{constructor(e){this._params=e,this._subscriptions=new g.w,this._currentEmphasizedAlertId=null}scrollToEmphasizedAlert(e,t){this._params.experimentClient.isGateEnabled(Ze.K.CheetahMergedWithExtensionScrolling)&&e.forEach((({alertId:e,visibility:i})=>{const s=this._params.getAlertById(e);if(s&&"emphasized"===i&&e!==this._currentEmphasizedAlertId){if(s.highlightRanges.length>1&&e===t)return;const i=s.highlightRanges[0];i&&(this._params.integration.scrollToHighlight(i),this._currentEmphasizedAlertId=e)}}))}dispose(){this._subscriptions.unsubscribe()}}const xt=(0,V.xb)(J),Rt=new Set(["onboarding","gdocsOnboardingPopup","loginSSO","accountMigration","standWithUkraineGrammarlySuspended","claimedUser","dataControl","noPaymentMethodSubscription","grammarlyBusinessSigninPopup","gdocsFeedbackUI"]),Ct=new Set(["onboarding","gdocsOnboardingPopup","loginSSO","accountMigration","standWithUkraineGrammarlySuspended","claimedUser","dataControl","grammarlyBusinessSigninPopup"]);function Ut(e){return"opened"===e.kind}class Et{constructor(e){this._params=e,this._subs=new g.w,this._log=p.Y.create("CheetahFeatureImpl"),this._inlineButtonUI=$.h.create(null),this._ideateButtonUI=$.h.create(null),this._expandedIdeateButtonUI=$.h.create(null),this._assistantUI=$.h.create(null),this._highlightUI=$.h.create(null),this._quasiCaretUI=$.h.create(null),this._onboardingUI=$.h.create(null),this._nativeCursorHider=$.h.create(F.none),this._lastRestartAttemptTime=$.h.create(0),this._contextHighlight=$.h.create(F.none),this._highlightsUpdater=new wt({getAlertById:e=>this._params.alertProcessor.alerts.getAlertById(e),highlightCollection:this._params.highlightCollection,alertStateService:this._params.alertStateService,logger:p.Y.create("cheetah.revision.highlights")}),this._highlightsScroller=new It({integration:this._params.integration,experimentClient:this._params.experimentClient,getAlertById:e=>this._params.alertProcessor.alerts.getAlertById(e)}),this._ideateButtonTooltipNotificationState=$.h.create(F.none),this._assistantFocused=$.h.create(!1),this._inlineButtonRecentlyPressed=$.h.create(!1),this._ideateButtonRecentlyHovered=$.h.create(!1),this._selectionRange=$.h.create(F.none),this._highlights=$.h.create([]),this._quasiCaretRect=$.h.create(F.none),this._assistantUIState=$.h.create(F.none),this._onboardingViewModels=$.h.create(F.none),this._ideateButtonRefChange=new m.xQ,this._disposed=new m.xQ,this._initialOnboardingBlockedForSession=$.h.create(!1),this._assistantServices=function(e,t,i,s,a,o,d,h,v,b,y,w,C,U,E,k,B,P,T,D,j,V,L,Z,Q,Y,K,J,X){const ee=new m.xQ,te=()=>(0,l.zG)(e.get(),W.fromOption((()=>new Error("checking service not initialized")))),ie={notify(e){null==X||X.info("received monitoring event",{event:e}),(0,l.zG)(te(),W.map((e=>e.sessionUuid)),W.map((t=>{"error"===e.kind?(K.cheetah.error(e,Q,t),"waitForContextTimeout"!==e.name&&"waitForAckTimeout"!==e.name||"getContext"!==e.source||(Date.now()-Z.get()>u.LK(5)?(Z.set(Date.now()),Y()):(0,l.zG)(e.name,(e=>"waitForAckTimeout"===e?"ack":"waitForContextTimeout"===e?"setContext":void(0,q.L0)(e)),(e=>K.cheetah.sessionRestartTimeout(e,Q,t))))):"info"===e.kind?K.cheetah.info(e,Q,t):"warn"===e.kind?K.cheetah.warning(e,Q,t):(0,q.L0)(e.kind)})))}},se=new Pe.t({inboundCAPIMessages:t,sendCAPIMessage:({action:e,data:t,shouldInjectRev:i,shouldInjectSessionId:s})=>(0,l.zG)(n.Uo(te()),n.tS((a=>a.sendMessage(e,t,i,s)))),monitoringService:ie}),ae=new Te.c(se),ne={user:$.h.combine(i,s,((e,t)=>({id:Oe.n.Id.create(e.id),isPremium:je.n5.isPremium(e),dialect:t}))),setDialect:a},re=new ze.L(se,h.view((0,l.ls)(F.chain((e=>F.fromNullable(e.cheetahState))),F.fold((()=>({enabled:!1})),(e=>({enabled:!0,userState:e})))))),oe=o.pipe(_.w(F.fold((()=>R.of(F.none)),(e=>e.sessionService.session.view(F.some))))),le=v.pipe(O.QV(z.E),M.R(((e,t)=>{const i=e.filter(Bt);return t&&Bt(t)?[...i,t]:i}),[]),I.U(we.Z$),G.shareReplay({bufferSize:1,refCount:!0})),de=A.aj([le,b,y]).pipe(I.U((([e,t,i])=>(0,l.zG)(e,F.filter((()=>t)),F.fold((()=>({})),(e=>({[Me.n.initialPopupAnchor]:i?{reference:e,placement:"top",offset:8,boundaryAreaPadding:10}:void 0,[Me.n.initialBTSPopupAnchor]:i?{reference:e,placement:"top",offset:8,boundaryAreaPadding:10}:void 0,[Me.n.rewriteTooltipAnchor]:{reference:e,placement:"top",offset:8,boundaryAreaPadding:10}}))))))),he=e=>{null==X||X.debug(`Completing step [${e}]`);C.get()[e].extension.completed||U({[e]:{completed:!0,lastSeen:Date.now()}})},ce=()=>{const e=new Set;E.get().rewrite&&k||e.add(xe.T.StepName.rewrite),E.get().compose||e.add(xe.T.StepName.initial),E.get().onboarding||(e.add(xe.T.StepName.initial),e.add(xe.T.StepName.initialBTS),e.add(xe.T.StepName.rewrite),e.add(xe.T.StepName.prompts),e.add(xe.T.StepName.review),e.add(xe.T.StepName.knowledgeHub),e.add(xe.T.StepName.references));const t=(0,l.zG)(h.get(),F.map((e=>"ASSIGNMENT_WRITING"===e.defaultDocumentContext.writingIntent)),F.getOrElse(l.jv));return E.get().onboardingBTS&&t||e.add(xe.T.StepName.initialBTS),E.get().knowledgeHubIntegration||e.add(xe.T.StepName.knowledgeHub),(0,Ge.Q)({upstreamOnboardingState:C,session:oe,textStats:d,forceDisabledOnboardingSteps:e,assistantUIActions:ee,externalElements:de,hideAssistantOnboardingTooltips:o.pipe(_.w(F.fold((()=>$.h.create(!1)),(e=>e.dragBehavior.pipe(I.U((e=>"draggable"===e.kind&&e.isDragging))))))),promptsAllocated:re.availability.view(Ie._.getPromptsAllocated),client:"extension",trackingService:ae,disposed:w,logger:$e.C8.Logging.getLogger("OnboardingCompletionEffects"),completeOnboardingStep:he})},pe={flush:()=>n.fF((()=>new H.y((t=>{const i=new g.w;return B.empty.get()?t.next(void 0):(B.flush(),(0,l.zG)(e.get(),F.fold((()=>t.next(void 0)),(e=>{i.add(e.messages.pipe(S.h((e=>e._tag===ye.J8.Type.submitOtAck)),N.L(500,R.of(null)),x.b((()=>t.next(void 0)))).subscribe())})))),()=>i.unsubscribe()})).pipe(f.q(1)).toPromise())),getText:e=>n.tD((()=>P(e))),insertText:e=>n.tD((()=>T(e))),copyText:e=>()=>(0,c.v)(e).pipe(f.q(1)).toPromise(),setContextHighlight:(e,t)=>{V.set(F.some({range:e,visibility:t}))},selectedRange:D,textUpdated:j},ue={reportUphookShow:e=>n.tD((()=>{e.isPremium||((0,qe.n)(L,{placement:"grammarlyGoPrompts",upgradeHookName:"grammarlyGoPrompts",upgradeHookSlot:"grammarlyGo"}),K.upgradeHooks.showUpgradeHook("grammarlyGoPrompts","grammarlyGo"))})),reportUphookClick:e=>n.tD((()=>{e.isPremium?self.open(r.Rd().appConfig.url.support):((0,qe.Q)(L,{placement:"grammarlyGoPrompts",upgradeHookName:"grammarlyGoPrompts",upgradeHookSlot:"grammarlyGo"}),K.upgradeHooks.clickUpgradeHook("grammarlyGoPrompts","grammarlyGo"),(0,We.wW)("upHook","grammarlyGoPrompts"))}))},ge={domain:R.of(Q),submitFeedback:e=>n.Y3((()=>(0,l.zG)(e.source,(e=>e===He.x.Source.resultCard?"cheetah-card":e===He.x.Source.quickReplyInitialActions||e===He.x.Source.intentCard?"cheetah-quick-reply":void(0,q.L0)(e)),(t=>L.feedbackFormSubmit(e.mood,t,e.domain,e.message)))),(e=>new Error(String(e))))},me=new Ne.p({capiService:se,monitoringService:ie}),ve=new Fe.j($.h.create({contextUpdatesClient:J.isGateEnabled(Ze.K.CheetahSelectionContextUpdates)&&"test"===J.getTreatment(Qe.p.CheetahSelectionContextUpdates),contextUpdatesServer:J.isGateEnabled(Ze.K.CheetahSelectionContextUpdatesServer)&&"test"===J.getTreatment(Qe.p.CheetahSelectionContextUpdates)})),_e=new De.w({capiService:se,logger:p.Y.create("cheetah.toneDetectorService")});return{capiService:se,userService:ne,genAIAvailabilityService:re,trackingService:ae,textEditorService:pe,feedbackService:ge,uphookService:ue,monitoringService:ie,userSurveyService:me,selectionContextAvailabilityService:ve,toneDetectorService:_e,createOnboardingViewModels:ce,notifyAssistantUIAction:e=>ee.next(e),dispose:()=>{re.dispose(),me.dispose(),ve.dispose()}}}(this._params.checkingService,this._params.checkingService.pipe(v.oA,_.w((e=>e.capiMessages))),this._params.user,this._params.dapiSettings.view((e=>{var t,i;return null!==(i=null!==(t=e.dialectStrong)&&void 0!==t?t:e.dialectWeak)&&void 0!==i?i:"american"})),(e=>n.fF((()=>this._params.dapiActions.changeStrongDialect(e)))),this._assistantUIState,this._params.textStats,this._params.capiStartAckMessage,this._ideateButtonRefChange,$.h.combine(this._params.integration.canShowIdeateButtonPopups,this._params.gButtonPopupState.view("type").view((e=>!Rt.has(e))),D.xD),$.h.combine(this._params.csPageState.view("cheetah").view((e=>(null==e?void 0:e.canShowInitialOnboarding)||(null==e?void 0:e.canShowInitialBTSOnboarding)||!1)),this._initialOnboardingBlockedForSession,((e,t)=>e&&!t)),b.T(this._params.csPageState.view("isActiveTab").pipe(S.h((e=>!e))),this._disposed).pipe(f.q(1)),this._params.dapiSettings.view((e=>function(e){const t=Ae.Z.State.toClientState(Ae.Z.decode(e.extension||""),"extension"),i=Ae.Z.State.toClientState(Ae.Z.decode(e.editor||""),"editor"),s=Ae.Z.State.toClientState(Ae.Z.decode(e.llamaMac||""),"llamaMac"),a=Ae.Z.State.toClientState(Ae.Z.decode(e.llamaWindows||""),"llamaWin");return(0,l.zG)(Ae.Z.State.empty,Ae.Z.State.patch(t,"extension"),Ae.Z.State.patch(i,"editor"),Ae.Z.State.patch(s,"llamaMac"),Ae.Z.State.patch(a,"llamaWin"))}({extension:e["cheetah:onboardingState"],editor:e["cheetah:onboardingState:editor"],llamaMac:e["cheetah:onboardingState:llamaMac"],llamaWindows:e["cheetah:onboardingState:llamaWindows"]}))),(e=>{this._params.dapiActions.modifyCheetahOnboardingState((0,l.ls)(Ae.Z.decode,(t=>(0,l.zG)(Ae.Z.State.toClientState(t,"extension"),(t=>({...t,...e})),(e=>Ae.Z.State.patch(e,"extension")(t)))),Ae.Z.encode))}),this._params.featureFlags,this._params.integration.enableInlineRewrites,this._params.textChangeBuffer,(e=>this._params.integration.getText(e)),(e=>this._insertText(e)),this._selectionRange,this._params.integration.textUpdated,this._contextHighlight,this._params.gnar,this._lastRestartAttemptTime,this._params.domain,(()=>this._restartAssistant()),this._params.telemetry,this._params.experimentClient,this._log),this._isOnboardingPopupVisible=$.h.create(!1),this._entryPointsEnabled=$.h.create(!1),this.inlineButtonUI=this._inlineButtonUI.view(),this.ideateButtonUI=this._ideateButtonUI.view(),this.expandedIdeateButtonUI=this._expandedIdeateButtonUI.view(),this.assistantUI=this._assistantUI.view(),this.highlightUI=this._highlightUI.view(),this.quasiCaretUI=this._quasiCaretUI.view(),this.onboardingUI=this._onboardingUI.view(),this.assistantState=this._assistantUI.view((0,l.ls)(F.fromNullable,F.fold((()=>({kind:"closed"})),(()=>({kind:"opened",supportsRevision:this._params.supportsRevision}))))),this.isOnboardingPopupVisible=this._isOnboardingPopupVisible.view(),this.isAvailable=$.h.combine(this._assistantServices.genAIAvailabilityService.availability.view((0,D.ff)(Ie._.isUnavailable)),this._params.csPageState.view("cheetah"),((e,t)=>{var i;return e&&!0===(null===(i=null==t?void 0:t.status)||void 0===i?void 0:i.cheetahEnabled)})),this.userSettings=this._assistantServices.genAIAvailabilityService.availability.view("userSettings"),this._params.dapiActions.reloadPropsRateLimited(),this._subs.add(this._params.checkingService.pipe(v.oA,_.w((e=>e.readyState)),S.h((e=>e===ye.kQ.ready)),f.q(1)).subscribe((()=>this._init()))),this._subs.add(this._setupIdeateTooltipStateObs());const t=this._onboardingViewModels.pipe(_.w(F.fold((()=>y.E),(e=>e.onboarding.uiActions))));this._subs.add(t.pipe(S.h(Tt)).subscribe((()=>{this._params.cheetahCSActions.cheetahInitialOnboardingShown()}))),this._subs.add(t.pipe(S.h(Ot)).subscribe((()=>{this._params.cheetahCSActions.cheetahInitialBTSOnboardingShown()}))),this._subs.add(this._getOnboardingVMStepActive([xe.T.StepName.initial,xe.T.StepName.initialBTS]).subscribe(w.wW(this._isOnboardingPopupVisible))),this._subs.add(this._params.gButtonPopupState.view("type").view((e=>Ct.has(e))).subscribe((e=>{e&&this._initialOnboardingBlockedForSession.set(!0)}))),this._subs.add(A.aj([this._params.gButtonDisabledReason,this._params.integration.entryPointsEnabled]).pipe(I.U((([e,t])=>t&&!function(e){const t=new Set([Le.P.DATA_CONTROL_ACTIVE,Le.P.OFFLINE,Le.P.STAND_WITH_UKRAINE,Le.P.USER_CLAIMED,Le.P.USER_EDC_BLOCKED,Le.P.SIGNED_OUT_GB]);return null!==e&&t.has(e)}(e)))).subscribe(w.wW(this._entryPointsEnabled))),this._subs.add(this._params.csPageState.view("cheetah").view((e=>{var t;return!1===(null===(t=null==e?void 0:e.status)||void 0===t?void 0:t.cheetahEnabled)})).subscribe((()=>this._closeAssistant(Ve.j.disposed)))),this._registerDebugHelpers()}closeAssistant(e){this._closeAssistant(e)}getHoveredStateBehavior(e){return this._highlightsUpdater.getHighlightVisualState(e)}_init(){this._subs.add(this._assistantFocused.subscribe((e=>this._log.debug("Assistant "+(e?"focused":"blurred"))))),this._subs.add(this._params.openAssistant.pipe(_.w((e=>this._openAssistant(e)))).subscribe()),this._subs.add(this._getInlineButtonUI().subscribe(w.wW(this._inlineButtonUI))),this._subs.add(this._getIdeateButtonUI().subscribe(w.wW(this._ideateButtonUI))),this._subs.add(this._getExpandedIdeateButtonUI().subscribe(w.wW(this._expandedIdeateButtonUI))),this._subs.add(this._getHighlightUI().subscribe(w.wW(this._highlightUI))),this._subs.add(this._getQuasiCaretUI().subscribe(w.wW(this._quasiCaretUI))),this._subs.add(this._getOnboardingUI().subscribe(w.wW(this._onboardingUI))),this._subs.add(this._updateSelectionRange().subscribe(w.wW(this._selectionRange))),this._subs.add(this._updateHighlightRects().subscribe(w.wW(this._highlights))),this._subs.add(this._updateQuasiCaretRect().subscribe(w.wW(this._quasiCaretRect))),this._subs.add(this._updateNativeCursor().subscribe()),this._subs.add(this._closeRewriteAssistantWhenUnfocused().subscribe()),this._subs.add(this.assistantState.subscribe((e=>{Ut(e)&&this._params.closeLegacyAssistant()}))),this._subs.add(this._createOnboardingViewModelWhenCheetahAvailable().subscribe()),this._subs.add(this._handleTryItOut().subscribe())}_handleTryItOut(){return this._onboardingViewModels.pipe(_.w(F.fold((()=>y.E),(e=>e.onboarding.uiActions))),S.h(Re.l.is(Re.l.Kind.tryItOut)),x.b((()=>this._params.openAssistant.next({mode:kt(this._params.integration.quickReplyContext.get())&&this._params.featureFlags.get().quickReply?"quickReply":"ideation"}))))}_getOnboardingVMStepActive(e){return this._onboardingViewModels.pipe(_.w(F.fold((()=>R.of(!1)),(t=>t.onboarding.activeStep.view((0,l.ls)(F.filter((e=>e.show)),F.map((t=>e.includes(t.name))),F.getOrElse(l.jv)))))),C.x())}_setupIdeateTooltipStateObs(){return this._assistantServices.genAIAvailabilityService.availability.pipe(U.O(null),E.G(),I.U((([e,t])=>e&&t&&Ie._.isPassive(e)&&Ie._.isActive(t)?F.some("You’ve got prompts!"):F.none)),_.w(F.fold((()=>R.of(F.none)),(e=>b.T(R.of(F.some(e)),R.of(F.none).pipe(k.g(3e3))))))).subscribe(w.wW(this._ideateButtonTooltipNotificationState))}_registerDebugHelpers(){!function(e){const t=self;t&&(t.cheetahDebug=t.cheetahDebug||{},Object.assign(t.cheetahDebug,e))}({clearOnboarding:()=>this._params.dapiActions.modifyCheetahOnboardingState((()=>Ae.Z.encode(Ae.Z.State.empty)))})}_createOnboardingViewModelWhenCheetahAvailable(){return $.h.combine(this._params.featureFlags,this._assistantServices.genAIAvailabilityService.availability.view(Ie._.isUsable),((e,t)=>e.onboarding&&t)).pipe(x.b((e=>this._onboardingViewModels.modify((t=>((0,l.zG)(t,j.bw((e=>e.onboarding.dispose()))),e?F.some(this._assistantServices.createOnboardingViewModels()):F.none))))))}_closeRewriteAssistantWhenUnfocused(){return this._assistantFocused.pipe(B.b(100),S.h((e=>!e&&(0,l.zG)(this._assistantUIState.view(F.map((({sessionService:e})=>e.session))).get(),F.fold(l.jv,(e=>e.view((e=>"started"===e.kind&&Ce.w.isRewriteOrQuickRewrite(e.mode)&&F.isNone(e.inProgressResult)&&0===e.results.length)).get()))))),x.b((()=>this._closeAssistant(Ve.j.assistantBlurred))))}_onClickIdeateButton(e){Ut(this.assistantState.get())?this._closeAssistant(Ve.j.closed):this._params.openAssistant.next({mode:e})}_updateSelectionRange(){return A.aj([this._params.integration.selectionRange,this.assistantState.view(Ut)]).pipe(I.U((([e,t])=>({selectionRange:e,assistantIsFocused:this._assistantFocused.get(),inlineButtonRecentlyPressed:this._inlineButtonRecentlyPressed.get(),ideateButtonRecentlyHovered:this._ideateButtonRecentlyHovered.get(),initialPopupOnboardingStepIsActive:this.isOnboardingPopupVisible.get(),assistantOpened:t}))),x.b((({inlineButtonRecentlyPressed:e,ideateButtonRecentlyHovered:t})=>{e&&this._inlineButtonRecentlyPressed.set(!1),t&&this._ideateButtonRecentlyHovered.set(!1)})),S.h((({selectionRange:e,assistantIsFocused:t,inlineButtonRecentlyPressed:i,ideateButtonRecentlyHovered:s,initialPopupOnboardingStepIsActive:a,assistantOpened:n})=>!n||!i&&!s&&(!F.isNone(e)||!t&&!a))),I.U((({selectionRange:e})=>e)))}_updateHighlightRects(){return e=this._selectionRange,t=this._contextHighlight,i=this._params.integration,A.aj([e.pipe(_.w(F.fold((()=>R.of([])),(e=>i.getHighlightRects(e).pipe(I.U((e=>e.map((e=>({rect:e,visibility:"visible"})))))))))),t.pipe(_.w(F.fold((()=>R.of([])),(e=>i.getHighlightRects(e.range).pipe(I.U((t=>t.map((t=>({rect:t,visibility:e.visibility}))))))))))]).pipe(I.U((([e,t])=>t.find((e=>"hidden"!==e.visibility))?t:e)));var e,t,i}_updateQuasiCaretRect(){return A.aj([this._selectionRange,this._highlightsUpdater.hasHighlights]).pipe(_.w((([e,t])=>(0,l.zG)(e,F.filter((()=>!this._params.supportsRevision||!t)),F.filter(h.SV.isCollapsed),F.fold((()=>R.of([])),(e=>this._params.integration.getHighlightRects(e)))))),I.U((e=>(0,l.zG)(e,a.c2,F.map((e=>e[e.length-1]))))))}_updateNativeCursor(){return $.h.combine(this._quasiCaretRect,this.assistantState.view(Ut),((e,t)=>(0,l.zG)(s.Y(F.option)({nativeUIHider:F.fromNullable(this._params.integration.createNativeUIHider),quasiCaretRect:e}),F.filter((()=>t)),j.ew((()=>{this._nativeCursorHider.modify((e=>((0,l.zG)(e,j.bw((e=>e.dispose()))),F.none)))})),j.bw((({nativeUIHider:e})=>{this._nativeCursorHider.modify((t=>((0,l.zG)(t,j.bw((e=>e.dispose()))),F.some(e()))))})))))}_closeAssistant(e){(0,l.zG)(this._assistantUIState.get(),j.bw((({dispose:e})=>e()))),this._assistantUIState.set(F.none),this._assistantUI.set(null),e!==Ve.j.closed&&e!==Ve.j.assistantBlurred||this._params.integration.focusTextField()}_restartAssistant(){this._log.info("reconnecting checking service and restarting session"),(0,l.zG)(this._assistantUIState.get(),F.map((({sessionService:e})=>e.session.get().mode)),j.bw((e=>{this._closeAssistant(Ve.j.disposed),(0,l.zG)(this._params.checkingService.get(),j.bw((e=>{e.reconnect()}))),Ce.w.isPushRewrite(e)?this._params.openAssistant.next({mode:"ideation"}):this._params.openAssistant.next({mode:e})})))}async _openAssistant(e){Ut(this.assistantState.get())&&this._closeAssistant(Ve.j.disposed),this._assistantFocused.set(!0),"pushRewrite"===e.mode&&this._selectionRange.set(F.some(e.transformRange));const t=new Ue.Z({logger:p.Y.create("cheetah.sessionService"),startSessionOptions:it(e,{disableKnowledgeEngine:"disabled"===this._params.dapiSettings.get().serengetiState||void 0},this._params.integration.quickReplyContext.get(),this._params.url),textEditorService:this._assistantServices.textEditorService,capiService:this._assistantServices.capiService,userService:this._assistantServices.userService,trackingService:this._assistantServices.trackingService,monitoringService:this._assistantServices.monitoringService,selectionContextAvailability:this._assistantServices.selectionContextAvailabilityService.availability}),{revisionEngine:i,dispose:s}=this._params.supportsRevision?await mt({capiService:this._assistantServices.capiService,sduiBufferService:this._params.sduiBufferService,alertProcessor:this._params.alertProcessor,initialFeed:tt(e),highlightsUpdater:this._highlightsUpdater,highlightsScroller:this._highlightsScroller,replacementService:this._params.replacementService,getFormattingService:this._params.getFormattingService,requestAwaitService:this._params.requestAwaitService,alertStateService:this._params.alertStateService,domain:this._params.domain,getSessionUuid:()=>{var e,t;return null!==(t=null===(e=F.toNullable(this._params.checkingService.get()))||void 0===e?void 0:e.sessionUuid)&&void 0!==t?t:null},telemetry:this._params.telemetry}):{revisionEngine:void 0,dispose:l.Q1},a={logger:p.Y.create("cheetah.ui"),toneDetectorService:this._assistantServices.toneDetectorService,textEditorService:this._assistantServices.textEditorService,userService:this._assistantServices.userService,genAIAvailabilityService:this._assistantServices.genAIAvailabilityService,trackingService:this._assistantServices.trackingService,uphookService:this._assistantServices.uphookService,feedbackService:this._assistantServices.feedbackService,monitoringService:this._assistantServices.monitoringService,userSurveyService:this._assistantServices.userSurveyService,selectionContextAvailabilityService:this._assistantServices.selectionContextAvailabilityService,sessionService:t,revisionEngine:i,theme:$.h.create({flatUI:this._params.supportsRevision}),notifyAssistantUIAction:this._assistantServices.notifyAssistantUIAction,settingsOptions:this._params.supportsRevision?{kind:"withView",getView:()=>this._params.settingsService.getView()}:void 0};try{const e=await this._params.getHostInfo(),i=await this._params.integration.renderAssistant((({sizeBehavior:i,dragBehavior:n,readyToDrag:r})=>{const{assistantUI:o,dispose:l}=(0,Ee.e)({...a,lifecycleService:{sizeBehavior:i,dragBehavior:n,readyToDrag:r,hostInfo:e,visuallyReady:()=>Promise.resolve(),focusStateChanged:({isFocused:e})=>(this._assistantFocused.set(e),Promise.resolve()),close:()=>(this._closeAssistant(Ve.j.closed),Promise.resolve())}});return this._assistantUIState.set(F.some({sessionService:t,dragBehavior:P.D(n),dispose:()=>{s(),l(),t.dispose(),this._assistantFocused.set(!1)}})),o}));this._assistantUI.set(d.createElement(oe,null,i))}catch(e){this._log.error("failed to open assistant",e),this._assistantUIState.set(F.none),this._assistantUI.set(null)}}_getInlineButtonUI(){return(0,l.zG)(s.Y(o.P)({inlineButtonInfo:this._params.integration.inlineButtonPlacement,selectionRange:this._selectionRange,selectionOngoing:b.T(this._params.integration.selectionRange.pipe(I.U((e=>(0,l.zG)(e,F.isSome)))),this._params.integration.selectionRange.pipe(B.b(100),T.h(!1))),assistantOpened:this.assistantState.view(Ut),textMapIsEmpty:this._params.integration.textMapIsEmpty,quickReplyContext:this._params.integration.quickReplyContext,availability:this._assistantServices.genAIAvailabilityService.availability,entryPointsEnabled:this._entryPointsEnabled,featureFlags:this._params.featureFlags})).pipe(I.U((({inlineButtonInfo:e,selectionRange:t,selectionOngoing:i,assistantOpened:s,textMapIsEmpty:a,quickReplyContext:n,availability:r,entryPointsEnabled:o,featureFlags:h})=>(0,l.zG)(e,F.filter((()=>o)),F.filter((()=>!s)),F.filter((()=>Ie._.isUsable(r))),F.fold(l.gn,(e=>(0,l.zG)(t,F.fold(l.gn,(t=>a&&F.isSome(n)&&h.inlineQuickReply?d.createElement(he,{disabled:!1,referenceElement:e.referenceElement,placement:e.placement,offset:F.toNullable(e.offset),onClick:()=>{this._inlineButtonRecentlyPressed.set(!0),this._params.openAssistant.next({mode:"quickReply"})}}):Pt(t)&&(h.inlineRewrite||h.magicRewrite)&&this._params.integration.enableInlineRewrites?d.createElement(pe,{disabled:i,referenceElement:e.referenceElement,placement:e.placement,offset:F.toNullable(e.offset),onOpenRewriteClick:h.inlineRewrite?()=>{this._inlineButtonRecentlyPressed.set(!0),this._params.openAssistant.next({mode:"rewrite"})}:void 0,onMagicRewriteClick:h.magicRewrite?()=>{this._inlineButtonRecentlyPressed.set(!0),this._params.openAssistant.next({mode:"quickRewrite"})}:void 0}):null)))))))))}_getOnboardingUI(){return this._onboardingViewModels.view(F.fold(l.gn,(e=>d.createElement(oe,null,L.UI.mount(ke.T,(0,Be.A)(e))))))}_getHighlightUI(){return $.h.combine(this._highlights,this.assistantState.view(Ut),this._assistantFocused,((e,t,i)=>t&&i?e.map((({rect:e,visibility:t},i)=>d.createElement(Q,{key:`cheetah-highlight-rect-${i}`,top:e.top,left:e.left,width:e.width,height:e.height,visibility:t}))):null))}_getQuasiCaretUI(){return $.h.combine(this._quasiCaretRect,this.assistantState.view(Ut),((e,t)=>(0,l.zG)(e,F.filter((()=>t)),F.fold((()=>null),(e=>d.createElement(be,{left:e.left,top:e.top,height:e.height,overflow:this._params.integration.allowCustomCaretOverflow}))))))}_getIdeateButtonUI(){return $.h.combine(this._params.featureFlags,this._inlineButtonUI,this._selectionRange,this._params.integration.quickReplyContext,this._assistantServices.genAIAvailabilityService.availability,this._entryPointsEnabled,((e,t,i,s,a,n)=>(0,l.zG)(t,F.fromPredicate((e=>null===e)),F.filter((()=>n&&e.ideateButton)),F.filter((()=>Ie._.isUsable(a))),F.fold(l.gn,(()=>this._getIdeateButtonForSelectionRange(i,s,e))))))}_getExpandedIdeateButtonUI(){return this._params.supportsRevision?$.h.create(null):$.h.combine(this._params.featureFlags,this._selectionRange,this._params.integration.quickReplyContext,this._assistantServices.genAIAvailabilityService.availability,this._entryPointsEnabled,((e,t,i,s,a)=>(0,l.zG)(s,F.fromPredicate((e=>Ie._.isVisible(e))),F.filter((()=>a&&e.ideateButton)),F.fold(l.gn,(()=>this._getIdeateButtonForSelectionRange(t,i,e))))))}_getIdeateButtonForSelectionRange(e,t,i){return this._params.supportsRevision?null:(0,l.zG)(e,F.filter((e=>Pt(e)&&i.rewrite)),F.fold((()=>kt(t)&&i.quickReply?"quickReply":i.compose?"ideation":null),(()=>"rewrite")),F.fromNullable,F.fold(l.gn,(e=>d.createElement(xt,{onMouseEnter:()=>this._ideateButtonRecentlyHovered.set(!0),onMouseLeave:()=>this._ideateButtonRecentlyHovered.set(!1),onClick:()=>this._onClickIdeateButton(e),mount:e=>this._ideateButtonRefChange.next(e),forceTooltipMessage:this._ideateButtonTooltipNotificationState.view(F.toUndefined)}))))}_insertText(e){""!==e?this._params.integration.insertText(e,this._selectionRange.get()):this._log.warn("insert() - attempting to insert empty response, skipping insert.")}dispose(){var e;this._disposed.next(null),this._highlightsUpdater.dispose(),this._closeAssistant(Ve.j.disposed),null===(e=F.toUndefined((0,l.zG)(this._onboardingViewModels.get(),F.map((e=>e.onboarding)))))||void 0===e||e.dispose(),this._assistantServices.dispose(),this._subs.unsubscribe(),(0,l.zG)(this._nativeCursorHider.get(),j.bw((e=>e.dispose()))),this._params.integration.dispose()}}function kt(e){return(0,l.zG)(e,F.exists((e=>Object.values(e).filter((e=>void 0!==e)).length>0)))}function Bt(e){return e.isConnected&&null!==e.offsetParent}function Pt(e){const t=e.end-e.start;return t>=10&&t<5e3}function Tt(e){return(0,D.W9)(Re.l.is(Re.l.Kind.mount),(e=>e.step===xe.T.StepName.initial))(e)}function Ot(e){return(0,D.W9)(Re.l.is(Re.l.Kind.mount),(e=>e.step===xe.T.StepName.initialBTS))(e)}},67534:(e,t,i)=>{i.d(t,{B:()=>o,g:()=>r});var s=i(17528),a=i(48015),n=i(36991);const r=e=>e.reduce((({actions:e,index:t},i)=>{const s=e[0];return n.s.isInsertString(i)?(e.unshift({pos:{start:t,end:t},value:i.insert}),{actions:e,index:t}):n.s.isInsertEmbed(i)?{actions:e,index:t+1}:n.s.isRetain(i)?{actions:e,index:t+i.retain}:n.s.isDelete(i)?(s&&s.pos.start===s.pos.end&&s.pos.end===t?s.pos={...s.pos,end:s.pos.end+i.delete}:e.unshift({pos:{start:t,end:t+i.delete},value:""}),{actions:e,index:t+i.delete}):void(0,a.vE)(i)}),{actions:[],index:0}).actions.reduce(((e,t)=>(e.length&&e[e.length-1].value&&e[e.length-1].pos.start===t.pos.start?e[e.length-1].value=`${t.value}${e[e.length-1].value}`:e.push(t),e)),[]),o=e=>e.reduce((({formattings:e,index:t},i)=>s.m.hasFormatting(i)?n.s.isInsertString(i)?(e.push({range:{start:t,end:"\n"===i.insert?t:t+i.insert.length},formatting:i.attributes}),{formattings:e,index:t+i.insert.length}):n.s.isInsertEmbed(i)?{formattings:e,index:t+1}:n.s.isRetain(i)?(e.push({range:{start:t,end:t+i.retain},formatting:i.attributes}),{formattings:e,index:t+i.retain}):{formattings:e,index:t}:n.s.isInsertString(i)?{formattings:e,index:t+i.insert.length}:n.s.isInsertEmbed(i)?{formattings:e,index:t+1}:n.s.isRetain(i)?{formattings:e,index:t+i.retain}:n.s.isDelete(i)?{formattings:e,index:t}:void(0,a.vE)(i)),{formattings:[],index:0}).formattings},88571:(e,t,i)=>{i.d(t,{Q:()=>l});var s=i(27378),a=i(15073),n=i(60797),r=i(95300),o=i(5114);const l=({children:e,remSize:t,setter:i})=>(d+=1,s.useEffect((()=>{const e=t.subscribe((e=>{h.next(o.some(e)),i(o.some(e))}));return()=>{e.unsubscribe(),d-=1,0===d&&(h.next(o.none),i(o.none))}}),[t]),s.createElement(a.u.Context.Provider,{value:h.pipe(n.oA)},e));let d=0;const h=new r.X(o.none)},57757:(e,t,i)=>{i.d(t,{v:()=>n});var s=i(44586),a=i(95195);function n(e,t=self){return new s.y((i=>{var s,n;(null===(n=null===(s=t.navigator)||void 0===s?void 0:s.clipboard)||void 0===n?void 0:n.writeText)?t.navigator.clipboard.writeText(e).then((()=>i.next(a.right(void 0)))).catch((e=>i.next(a.left(new Error(String(e)))))):i.next(a.left(new Error("The Clipboard API is not available.")))}))}},51325:e=>{e.exports={highlightRect:"XWxTA",hidden:"o979x",attention:"bHjcD",blink:"oy7wj"}},16805:e=>{e.exports={ideateButton:"_ErYR",ideateButtonIcon:"i8HXG",spin:"CSZH1"}},87491:e=>{e.exports={entryButton:"cDocn",entryButtonItem:"dJCJe",rewriteIcon:"wGNWN",openIcon:"vIUqu",spin:"A8MjA"}},50783:e=>{e.exports={replyButton:"ZfD1U",icon:"BdxRh",spin:"MBS28"}},48033:e=>{e.exports={quasiCaret:"WhbAl",icon:"Yd_W5"}}}]);