var Helpers = (function(){

  var cleanHTML = function( html, filter ){
    html = html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
    html = html.replace(/<style[\s\S]*?\/style>/ig, '');
    html = html.replace(/onload=".*?"/ig, '');
    if (filter && filter.image) {/*...*/}
    else html = html.replace(/<img[^>]*>/ig, '');
    if (filter && filter.form) {/*...*/}
    else html = html.replace(/<form [\s\S]+?<\/form>/ig, '');
    return html;
  };


  var escapeHtml = function(str) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
  };


  var convertPriceToNumber = function(text){
    var n = text.replace(/[^\d,.]+/g, '');
    // special case for currency with dot, e.g. "rub."
    if (n.substr(-1) === '.') n = n.substr(0, n.length - 1);
    if (!n) return 0;
    var separator;
    if ( n.substr( -3, 1).match(/[.,]/) ) separator = n.substr(-3,1);
    else if ( n.substr( -2, 1).match(/[.,]/) ) separator = n.substr(-2,1);
    else separator = getDecimalSeparator();
    if (separator === '.') n = n.replace(/,/g, '');
    if (separator === ',') {
      n = n.replace(/\./g, '');
      n = n.replace(',', '.');
    }
    return parseFloat(n);
  };


  var getDecimalSeparator = function() {
    var decSep = ".";
    try {
      var sep = parseFloat(3/2).toLocaleString().substring(1,2);
      if (sep === '.' || sep === ',') {
        decSep = sep;
      }
    } catch(e){}
    return decSep;
  };


  var getDate = function(){
    var a = new Date();
    var year = a.getFullYear();
    var month = ('0' + (a.getMonth() + 1)).substr(-2);
    var day = ('0' + a.getDate()).substr(-2);
    var hours = ('0' + a.getHours()).substr(-2);
    var min = ('0' + a.getMinutes()).substr(-2);
    var sec = ('0' + a.getSeconds()).substr(-2);
    var time = year + month + day + '-' + hours + min + sec;
    return time;
  };


  return {
    cleanHTML: cleanHTML,
    escapeHtml: escapeHtml,
    convertPriceToNumber: convertPriceToNumber,
    getDate: getDate
  };

})();

var AMZHelpers=function(){var e={items:["s-result-item","zg_itemImmersion"].map((function(e){return"."+e})).join(", ")},r=function(r){var t=e.items;return r.find(t).filter((function(e,r){return""!==r.dataset.asin}))},t=function(e){var r=e.find(".a-row").filter((function(e,r){return!!$(r).find(".a-icon-star, .a-icon-star-small")[0]}))[0];if(!r)return{reviews:0,rating:-1};var t=$.trim(r.textContent.replace(/\r?\n/g," ")),a=(t.match(/([\d,.]+)$/)||[])[1]||"-1",n=(t.match(/^([\d,.]+)/)||[])[1]||"-1";return a=a.replace(/[.,]/g,""),n=n.replace(/[.,]/,"."),{reviews:parseInt(a),rating:parseFloat(n)}};return{getListRoot:function(){var e=["#s-results-list-atf","#zg_centerListWrapper",".s-result-list"].join(", "),r=$(e);if(r[0])return $(r[0])},getItems:r,getItemData:function(e){var r=e.find(".xtaqv-root"),a=e[0].dataset.asin,n=-1;r.data("rank-done")&&(n=(n=(n=e.find(".extension-rank").text()).replace(/[^\d]/g,""))?parseInt(n):0);var i=e.find(".a-price:not([data-a-strike]) .a-offscreen");i.length||(i=e.find(".a-color-price"));var s=i.text(),o=-1,d=-1;if(-1!==s.indexOf("-")){var l=s.match(/[\d,.]+/g);l&&(o=Helpers.convertPriceToNumber(l[0]),d=Helpers.convertPriceToNumber(l[1]))}else o=d=s=Helpers.convertPriceToNumber(s);var f=!!e.find('i[aria-label="Prime"]')[0];f||(f=!!e.find('i[aria-label="Amazon Prime"]')[0]);var c=!!e.find("[data-badge=nobb]")[0],u=-1,p=-1,m=-1;r.data("offers-done")&&(m=!!e.find('[data-badge="soldbyamz"]')[0],(u=e.find('[data-badge="fbasellers"]').text())&&(p=u.match(/^(\d+\+?)/)[1]),u=u?parseInt(u.match(/^(\d+)/)[1]):0,-1!==p.toString().indexOf("+")&&(p=parseFloat(p.replace(/\+/,".5"))));var v=t(e),g=!!e.find(".s-sponsored-label-info-icon")[0]||!!e.find(".puis-sponsored-label-text")[0];return{asin:a,rank:n,priceMin:o,priceMax:d,isPrime:f,soldByAMZ:m,noBB:c,fbaSellers:u,fbaSellersPlus:p,reviews:v.reviews,rating:v.rating,sponsored:g}},getItemNode:function(e){return $(`.s-result-item[data-asin=${e}]`)},isSearchPage:function(){return!!r($("body")).length},getSearchKeyword:function(){var e="",r=$("#nav-search input[type=text].nav-input");return r[0]&&(e=r[0].value),e}}}();
var Widget=function(t){this.id=t.id||"",this.src=t.src,this.parent=t.parent||document.body,this.$root=null,this.$iframe=null,t.prepend&&(this.prepend=!0),this.onReady=t.onReady};Widget.prototype.inject=function(){var t="appendTo";this.prepend&&(t="prependTo"),this.$root=$("<div/>").attr("id",this.id)[t]($(this.parent)),this.$iframe=$("<iframe/>").attr("src",this.src).appendTo(this.$root)},Widget.prototype.show=function(){this.$root||this.inject(),this.$root.show()},Widget.prototype.hide=function(){this.$root&&this.$root.hide()},Widget.prototype.remove=function(){this.$root&&this.$root.remove()},Widget.prototype.resize=function(t){t.width&&this.$iframe.css({width:t.width}),t.height&&this.$iframe.css({height:t.height})},Widget.prototype.post=function(t,i){this.$iframe?this.$iframe[0].contentWindow.postMessage({cmd:t,data:i},"*"):console.error("Iframe not found")},Widget.prototype.onMessage=function(t,i){"widget.ready"===t?"function"==typeof this.onReady&&this.onReady():"widget.resize"===t?this.resize(i):"widget.close"===t&&this.hide()};
var Captcha=function(){var e,n=!1,t=null,a=function(){n=!1,t&&(t.remove(),t=null)},c=function(n){t||(t=$("<div/>").attr("id","xtaqv-captcha-root").addClass("xtaqv-vis-hidden").html(i(n)).appendTo($("body"))).find("a").click((function(n){n.preventDefault(),a(),chrome.runtime.sendMessage({cmd:"captcha.resolved"}),e&&e()}))},i=function(e){return['<div class="xtaqv-captcha-header">Amazon CAPTCHA prompt</div>',"<div>",'<iframe src="'+e+'"/>',"</div>",'<div class="xtaqv-captcha-continue">','You see this message because "DS Amazon Quick View" extension detected Amazon captcha request. Please solve the captcha to continue extension working.','<a href="#">Close this window.</a>',"</div>"].join("\n")};return{init:function(n){e=n.onResolved},findHTML:function(e){return-1!==e.indexOf("validateCaptcha")},find:function(){return!!document.querySelector("#captchacharacters")},process:function(e,t){n||(n=!0,chrome.runtime.sendMessage({cmd:"captcha.prompt",data:{url:t}}),c(t))},reveal:function(){t&&t.removeClass("xtaqv-vis-hidden")},resolve:a}}();
var InfiniteScroll=function(){var t,n,e=!1,i=null,a=null,r=function(){if(!i){var t=['<div class="xtaqv-scroll-status-wrap">','<div class="xtaqv-scroll-message"></div>','<a class="xtaqv-scroll-stop">Stop</a>',"</div>"].join("\n");(i=$("<div/>",{class:"xtaqv-scroll-status xtaqv-hidden"}).html(t).appendTo("body")).find(".xtaqv-scroll-stop").click((function(t){t.preventDefault(),e=!1,a&&(clearTimeout(a),a=null),o()}))}},s=function(t,n){i?(t="DS Amazon Quick View Infinite Scroll: <strong>"+t+"</strong>",i.find(".xtaqv-scroll-message").html(t),i.removeClass("xtaqv-hidden"),n&&setTimeout(o,n)):console.log("No status node")},o=function(){i.addClass("xtaqv-hidden")},l=function(t){var n="",e=$(".s-pagination-next",t);if(e[0])n=e.prop("href");else{var i=(e=$(".a-pagination .a-last",t)).text();["Next","Suivant","Volgende","Siguiente","Avanti","PrÃ³ximo"].map((function(t){-1!==i.indexOf(t)&&(n=e.find("a").prop("href"))}))}return n},u=function(e){var i=(new DOMParser).parseFromString(e,"text/html"),a=["s-result-item:not(.s-widget)","zg_itemImmersion"].map((function(t){return"."+t})).join(", "),r=$(a,i);s("Processing items: "+r.length,1e3),t=l(i);var o=function(){var t=["#s-results-list-atf","#zg_centerListWrapper",".s-result-list.s-main-slot"].join(", "),n=$(t);if(n[0])return $(n[0])}(),u=o.find(".s-pagination-container").closest(".s-result-item");o[0]&&r.map((function(t,e){var i=$(e);i.insertBefore(u),n&&n(i)}))};return{init:function(i){AMZHelpers.isSearchPage()&&(i.onItemAdded&&(n=i.onItemAdded),e=!0,r(),t=l(document.body))},setStatus:s,loadNextPage:function(){if(e){var n=t;if(!n)return e=!1,0;s("Loading next page"),a=setTimeout((function(){chrome.runtime.sendMessage({cmd:"add_ajax_task",data:{url:n,priority:!0}},(function(t){if(a=null,t.error)return console.error(t),void s("Error: "+t.statusText,3e3);u(t.data)}))}),2e3)}},isLoading:function(){return!!a}}}();
var Filters=function(){var e,t={},r={},i=document.location.href,s=function(){chrome.runtime.onMessage.addListener((function(e,t,r){var i=e.cmd,s=e.data;"app.update_state"===i&&l(s.state,s.settings)}))},n=function(){window.addEventListener("message",(function(r){var i=r.data;if("object"==typeof i){var s=i.cmd,n=i.data;if(s)if(s.match(/^widget\./))e.onMessage(s,n);else if("iframe.close"===i.cmd)$iframeRoot.remove();else if("setting.set"===s){for(var a in n)t[a]=n[a];c()}else"export"===s?v(n):"clear-selected"===s?$(".xtaqv-selected").removeClass("xtaqv-selected"):"sort"===s?m(n):"reset-filters"===s&&console.log("reset filters")}}),!1)},a=function(){var r=$(window),i=e.$root.offset().top;e.$root.css({width:e.$iframe.width()}),r.scroll((function(s){t.showFiltersOnTop&&(r.scrollTop()>i?e.$root.addClass("xtaqv-filters-fixed"):e.$root.removeClass("xtaqv-filters-fixed"))}))},o=function(){$("body").on("mouseenter",".xtaqv-root",(function(e){var t=$(this),r=$("<div/>",{class:"xtaqv-mark"}).html('<input type="checkbox" title="Mark for Export"/>');r.find("input").prop("checked",t.hasClass("xtaqv-selected")).click((function(e){t.toggleClass("xtaqv-selected",!!this.checked)})),r.appendTo(t)})),$("body").on("mouseleave",".xtaqv-root",(function(e){$(this).find(".xtaqv-mark").remove()}))},l=function(r,i){i.showFilters?(Object.keys(t).length||(t=$.extend({},i)),d()):(e.hide(),AMZHelpers.getItems($("body")).show())},c=function(){t.showFiltersOnTop||e&&e.$root.removeClass("xtaqv-filters-fixed"),AMZHelpers.getItems($("body")).map((function(e,t){var r=$(t);f(r)?r.show():r.hide()}))},d=function(){var t=$('#resultsCol, #mainResults, [data-component-type="s-search-results"]')[0];t||(t=$(".s-result-list")[0]),t?(e||(e=new Widget({id:"xtaqv-filter",src:chrome.runtime.getURL("html/filters.html"),parent:t,prepend:!0,onReady:a})),e.show(),c()):console.log("Can't find a parent to render filters")},f=function(e,s){var n={};for(var a in s||(s=t),s)0===a.indexOf("filter")&&(n[a.replace(/^filter/,"")]=s[a]);var o=AMZHelpers.getItemData(e),l=!0;return-1!=o.rank&&n.RankMin>=0&&o.rank<n.RankMin&&(l=!1,"rank"),-1!=o.rank&&n.RankMax>0&&o.rank>n.RankMax&&(l=!1,"rank"),-1!=o.fbaSellers&&-1!=n.FBASelMax&&o.fbaSellers>n.FBASelMax&&(l=!1,"fbaSellers"),-1!=o.fbaSellers&&-1!=n.FBASelMin&&o.fbaSellers<n.FBASelMin&&(l=!1,"fbaSellers"),-1!=o.soldByAMZ&&n.HideSoldByAMZ&&o.soldByAMZ&&(l=!1,"soldByAMZ"),n.HideSponsored&&o.sponsored&&(l=!1,"sponsored"),n.HideNoBB&&o.noBB&&(l=!1,"noBB"),n.PriceMin>=0&&o.priceMax<n.PriceMin&&(l=!1,"price"),n.PriceMax>=0&&o.priceMin>n.PriceMax&&(l=!1,"price"),o.isPrime&&n.HidePrime&&(l=!1,"prime"),n.ReviewsMin>=0&&o.reviews>=0&&o.reviews<n.ReviewsMin&&(l=!1,"reviews"),n.ReviewsMax>=0&&o.reviews>=0&&o.reviews>=n.ReviewsMax&&(l=!1,"reviews"),n.RatingMin>=0&&o.rating>=0&&o.rating<n.RatingMin&&(l=!1,"rating"),document.location.href!==i&&(r={},i=document.location.href),o.asin&&(r[o.asin]=l),p(),l},p=function(){var t=Object.keys(r).length,i=0,s=0;for(var n in r)r[n]?i++:s++;e&&e.post("updateUI",{counters:{total:t,good:i,bad:s}})},m=function(e){var t=e.dir,r=e.metric,i=AMZHelpers.getItems($("body")),s=[],n=AMZHelpers.getListRoot();i.map((function(e,t){var r=$(t),i=AMZHelpers.getItemData(r);i.node=t,s.push(i)})),s.sort((function(e,i){var s=e[r],n=i[r],a=0;return s<n?a=-1:s>n&&(a=1),"desc"===t&&0!==a&&(a=-a),a})),s.map((function(e){AMZHelpers.getItemNode(e.asin).appendTo(n)}))},v=function(e){var t=AMZHelpers.getItems($("body")),r=[],i=[["ASIN","asin"],["BSR","rank"],["MIN Price","priceMin"],["MAX Price","priceMax"],["Reviews","reviews"],["Average Rating","rating"],["FBA Sellers","fbaSellersPlus"],["Sold by AMZ","soldByAMZ"],["Prime","isPrime"]],s=i.map((function(e){return e[0]}));r.push('"'+s.join('";"')+'"'),t.map((function(t,s){var n=$(s);if(n.is(":visible")&&("marked"!=e||n.find(".xtaqv-selected")[0])){var a=AMZHelpers.getItemData(n),o=[];i.map((function(e){var t=e[1],r=a[t];-1===r&&(r=""),"isPrime"===t&&r&&(r="Prime"),"soldByAMZ"===t&&r&&(r="Sold by AMZ"),"fbaSellersPlus"===t&&parseInt(r)<r&&(r=parseInt(r)+" or more"),!1===r&&(r=""),o.push('"'+r+'"')})),r.push(o.join(";"))}}));var n=r.join("\n"),a="data:application/csv;charset=utf-8,"+encodeURIComponent(n),o=AMZHelpers.getSearchKeyword().replace(/ /g,"_");o&&(o+="_"),o+=Helpers.getDate()+".csv",u(a,o)},u=function(e,t){var r=document.createElement("a");r.download=t,r.href=e,r.click()};return{init:function(){AMZHelpers.isSearchPage()&&(n(),s(),o(),chrome.runtime.sendMessage({cmd:"app.get_state"},(function(e){e.state&&"ok"===e.license&&(e.settings&&!e.settings.showFilters||(t=$.extend({},e.settings),d()))})))},filter:function(e){AMZHelpers.getItems($("body")).map((function(e,t){var r=$(t);passFilters(r)?r.show():r.hide()}))},applyFiltersToItem:f}}();Filters.init();
var Module=function(){var e,t,a=!1,n=!1,i=!1,r=function(){return!!$("#heroImage, #title_feature_div, #booksTitle, #superleafProductAlert_feature_div, #mediaProductTitle_feature_div, #audibleProductTitle")[0]},o=function(){chrome.runtime.onMessage.addListener((function(t,n,i){"app.update_state"==t.cmd?(a=t.data.state,e=t.data.settings,t.data.license,u(),U()):"captcha.resolve"===t.cmd&&(Captcha.resolve(),m())}))},s=function(){window.addEventListener("message",(function(e){var t=e.data;if("object"==typeof t){var a=t.cmd;t.data;a&&"xtaqv-premium.captcha_reveal"===a&&Captcha.reveal()}}),!1)},l=function(){var t=$(window);t.scroll((function(n){if(a&&e.showFilters&&e.infiniteScroll){var i=$(".s-pagination-strip");if(i[0]||(i=$(".a-pagination")),i[0]){var r=i.offset();if(r){var o=r.top;t.scrollTop()+t.height()+100>o&&(InfiniteScroll.isLoading()||InfiniteScroll.loadNextPage())}}}}))},d=function(){var e=document.querySelector("#main");if(e&&(e=e.parentNode),e||(e=document.querySelector("#main")),e||(e=document.querySelector("#zg_centerListWrapper")),e||(e=document.querySelector("#zg")),e||(e=document.querySelector("#zg_left_col1")),e||(e=document.querySelector("#search")),e){new MutationObserver((function(e){a&&e.forEach((function(e){if("childList"===e.type){var t=[],a=["s-result-item","zg_itemImmersion","zg-item-immersion","zg_itemRow"];if(e.addedNodes[0]&&$(e.addedNodes[0]).closest(".xtaqv-root")[0])return;if(1===e.addedNodes.length){var n=a.map((function(e){return"."+e})).join(", "),i=$(e.addedNodes[0]);(t=i.find(n)).length||(a.map((function(e){i.hasClass(e)&&t.push(i[0])})),"gridItemRoot"===i.attr("id")&&t.push(i[0]))}else e.addedNodes.length>1&&$.each(e.addedNodes,(function(e,n){e=0;for(var i=a.length;e<i;e++){var r=a[e];if($(n).hasClass(r))t.push(n);else{var o=$(n).find("."+r);o[0]&&o.map((function(e,a){t.push(a)}))}}}));p(t)}}))})).observe(e,{subtree:!0,childList:!0,characterData:!0})}},c=function(){t=$('<div id="xtaqv-popup" class="xtaqv-premium"></div>').appendTo($("body")).hide().mouseleave((function(){t.hide()})),chrome.runtime.sendMessage({cmd:"clear_tasks",data:{}}),Captcha.find()||chrome.runtime.sendMessage({cmd:"captcha.resolved",data:{}}),$(window).on("beforeunload",(function(){chrome.runtime.sendMessage({cmd:"tab.unloaded",data:{}})}))},m=function(){$(document).ready((function(){(i=!!$("#aod-background")[0])||$("script").text().indexOf("AllOffersDisplayIngressAssets")>-1&&(i=!0),-1===document.location.href.indexOf("/gp/bestsellers")&&-1===document.location.href.indexOf("/Best-Sellers-")&&-1===document.location.href.indexOf("/gp/")||(i=!0);var e=$(".s-result-list > li");if(e.length||(e=$(".s-result-list > .s-result-item:not(.s-widget), .s-widget [data-asin]")),e.length||(e=$("#zg_centerListWrapper > .zg_itemImmersion, .zg_itemRow")),e.length||(e=$("#zg .zg-item-immersion")),e.length||(e=$("#browse-grid-view .browse-grid-view-item-unit.browse-clickable-item")),e.length||(e=$("#searchWidget .a-fixed-left-grid")),e.length||(e=$(".p13n-desktop-grid #gridItemRoot")),e.length||(e=$('[data-testid="product-grid-container"] li[data-testid="product-grid-item"]')),!e.length){e=$("#sp_detail li div[data-asin], #sp_detail_thematic-highly_rated li div[data-asin]"),["#sp_detail","#sp_detail_thematic-highly_rated"].map((function(e){f(e)}))}e.length,p(e)}))},f=function(e){var t=document.querySelector(e);if(t){new MutationObserver((function(e){e.forEach((function(e){if("childList"===e.type)for(var t=e.addedNodes,a=0,n=t.length;a<n;a++){var i=t[a];i.nodeType===Node.ELEMENT_NODE&&(i.dataset.asin&&(h(i),$(i).closest(".a-carousel-viewport").css("height","auto")))}}))})).observe(t,{subtree:!0,childList:!0,characterData:!0})}},u=function(){var t=$(".extension-sub-rank").parent("");e.hideSubrank?($(".xtaqv-result .zg_hrsr").hide(),t.hide(),$(".xtaqv-result").find("br").hide()):($(".xtaqv-result .zg_hrsr").show(),t.show(),$(".xtaqv-result").find("br").show())},p=function(e){for(var t=0,a=e.length;t<a;t++)h(e[t])},h=function(e){if(""!==e.dataset.asin){var t=$(e),a=g(t);if(a){var i=!!a.hasPriority,r=e.dataset.asin;if(!r){var o=t.find(".p13n-sc-uncoverable-faceout");o[0]&&(r=o[0].id)}var s=t.find('.a-link-normal, .zg_image a, a[data-testid="grid-item-image"]');if(s.length||r){var l,d=function(e){for(var t=0,a=e.length;t<a;t++){var i,r=e[t];if(r.href.match(/\/dp\/\w+\//))return r.href;if(r.href.match(/\/gp\/product\/\w+[/?]/))return r.href;if(r.href.match(/gp\/slredirect\/picassoRedirect.html/))if(i=r.href.match(/\%2Fdp\%2F([\w]+)\%/)){var o=i[1];return document.location.origin+"/dp/"+o+"/"}if(n&&r.href.match(/\/gp\/offer-listing\//))if(i=r.href.match(/\/gp\/offer-listing\/([\w]+)/)){o=i[1];return document.location.origin+"/dp/"+o+"/"}}return""}(s);if(!r){if(!d)return void console.log("No item URL");(r=(d.match(/\/dp\/(\w+)\//)||[])[1])||(r=(d.match(/\/gp\/product\/(\w+)[/?]/)||[])[1])}d?l=d:r&&(l=document.location.origin+"/dp/"+r);var c=t.find(".s-item-container");if(c.length||(c=t.find(".rsltR")),c.length||(c=t.find(".zg_image")),c.length||(c=t.find(".zg_itemWrapper")),c.length||(c=t.find(".a-cardui")),c.length||(c=t.find(".zg-item")),c.length||(c=t.find("[data-p13n-asin-metadata]")),!c.length&&t.hasClass("a-fixed-left-grid")&&(c=t),c.length||(c=$(t.find(".sg-row")[1])),c.length||(c=t.find(".s-title-instructions-style").parent()),c.length||(c=t.find("[cel_widget_id] .a-section:not(.s-color-swatch-container) > .a-section:last-child:not(.s-color-swatch-container)")).length||(c=t.find(".sg-col-inner > .a-section:last-child:not(.s-color-swatch-container), .sg-col-inner > div > .a-section:last-child:not(.s-color-swatch-container), .sg-col-inner > span > div > .a-section:last-child:not(.s-color-swatch-container), .sg-col-inner > span > span > div > .a-section:last-child:not(.s-color-swatch-container), .sg-col-inner > .a-section:not(.s-color-swatch-container) > .a-section:last-child:not(.s-color-swatch-container)")),c.length||(c=$(t.find("> .a-row:last-child")[0])).length&&($("#sp_detail .a-carousel-viewport").css("height","auto"),$("#sp_detail_thematic-highly_rated .a-carousel-viewport").css("height","auto")),c.length||(c=$(t.find(".browse-grid-view-item-unit ul[role=presentation]")[0])).length&&t.css("height","55rem"),!c.length&&n&&(c=$(t.find("table")[0]).parent()),c.length){(t.hasClass("zg-item-immersion")||c.hasClass("a-cardui"))&&(t[0].style.height="auto");for(var m=0,f=0,u=c.length;f<u;f++)c[f].closest(".a-popover-preload")||(m=f);var p=$("<div/>").addClass("xtaqv-root xtaqv-premium").html(b(r)).appendTo(c[m]);y(p,r),j(t),v(l,i,(function(e){_(t,e,l,r)})),I(t,r,i)}}}}},g=function(e){var t=e.find(".xtaqv-root");return t[0]?!!t.data("captcha")&&(t.remove(),{hasPriority:!0}):{}},v=function(e,t,a){chrome.runtime.sendMessage({cmd:"add_ajax_task",data:{url:e,priority:t}},(function(e){a(e)}))},b=function(e){var t=function(e,t){var a="https://"+D()+".camelcamelcamel.com/product/"+e;return"bsr"===t&&(a=x("href",e)),a};return['<div class="xtaqv-result">Loading rank... <img src="'+chrome.runtime.getURL("img/spinner16.gif")+'"/></div>','<div class="xtaqv-ext">','<span class="xtaqv-asin"><strong>ASIN:</strong> <span class="xtaqv-copy">'+e+"</span></span>","</div>",'<div class="xtaqv-charts">','<a data-src="price" href="'+t(e,"price")+'" target="_blank">Price History</a>','<a data-src="bsr_static" href="'+t(e,"bsr")+'" target="_blank">BSR Chart</a>','<a data-src="bsr" href="'+t(e,"bsr")+'" target="_blank"><img src="'+chrome.runtime.getURL("img/keepa.png")+'"></a>',"</div>"].join("\n")},x=function(e,t){var a={"co.uk":"2",fr:"4",de:"3",es:"9",it:"8",com:"1",ca:"6","com.mx":"11","com.br":"12","co.jp":"5",cn:"7",in:"10","com.au":"13"}[document.location.host.replace(/^.*\.amazon\./,"")]||1;return"href"===e?"https://keepa.com/#!product/"+a+"-"+t:"chart"===e?"https://keepa.com/iframe_addon.html#"+a+"-0-"+t:void 0},y=function(a,n){a.find(".xtaqv-charts a").mouseenter((function(t){if(!e.showPopupByKeypress||t.ctrlKey||t.metaKey){var a=B(this.dataset.src,n);S(t,a,"top")}})).mouseleave((function(e){$(e.toElement).closest("#xtaqv-popup")[0]||t.html("").hide()})),a.on("click",".xtaqv-copy",(function(e){var t=this.textContent,a=t;this.dataset.title&&(a=this.dataset.title);var n=this;w(a),this.textContent="Copied",setTimeout((function(){n.textContent=t}),750)}))},w=function(e){var t=document.createElement("textarea");document.body.appendChild(t),t.style.position="absolute",t.style.left="-9999px",t.value=e,t.select(),document.execCommand("Copy",!1,null),document.body.removeChild(t)},_=function(a,n,i,r,o){var s=a.find(".xtaqv-result"),l=a.find(".xtaqv-root");if(!l.data("rank-done")){var d,c,m={};if(n&&!n.error){var f=n.data;if(Captcha.findHTML(f))return s.text("CAPTCHA"),l.data("captcha",!0),void Captcha.process(a,i);var p=(new DOMParser).parseFromString(f,"text/html");if(d=P(p,i),o||(c=L(p),M(c,a),T(p,a),m.title=$.trim($("#productTitle",p).text()),m.title6wordsEsc=Helpers.escapeHtml(m.title.split(/\s+/).splice(0,6).join(" ")),m.titleEsc=Helpers.escapeHtml(m.title)),l.data("rank-done",!0),d){var h=C(d,f),g=h.rankStr,b=h.details;b.title=m,A(b,a);var x=z(g);((g=(g=(g=g.replace(/<b>.*?<\/b>/,"")).replace(/([Tt]op \d+( Paid)?) in/,"$1&nbsp;in")).replace(/([#\d,.]+)( Paid)?\s+(in|en|em)/g,'<span class="extension-sub-rank">$1</span> in')).match(/[tT]op 100/)||-1!==g.indexOf("les 100 premiers")||x.bsr)&&(g=g.replace(/-sub-rank/,"-rank")),(g=g.replace(/[^>]+[tT]op 100[^<]*<\/a>/,"Top 100</a>"))?(s.html(g),x.bsr||k(g,s,r)):s.html("Rank not found"),a.find(".zg_itemWrapper")[0]&&(a[0].style.removeProperty("height"),a.find(".zg_itemWrapper")[0].style.removeProperty("height")),u(),j(a),$(a.find(".s-access-image").get(0)).closest(".a-row, li").add(a.find(".zg_itemImageImmersion")).add(a.find(".zg_itemWrapper img")).add(a.find(".zg_itemRow img")).add(a.find(".zg-item img")).add(a.find(".p13n-grid-content img")).add(a.find("img.a-thumbnail-left")).add(a.find('[data-component-type="s-product-image"] img')).mouseenter((function(t){e.showExtInfo&&(!e.showPopupByKeypress||t.ctrlKey||t.metaKey)&&S(t,d)})).mouseleave((function(e){$(e.toElement).closest("#xtaqv-popup")[0]||t.html("").hide()}))}else{var y=new URL(i);if(!(y.searchParams.has("th")&&y.searchParams.has("psc"))&&$("#twister_feature_div",p)[0]){l.data("rank-done",!1),y.searchParams.append("th",1),y.searchParams.append("psc",1);var w=y.toString();v(w,!0,(function(e){_(a,e,w,r,"thpsc")}))}else s.text("Rank not found")}}else s.text("Error: "+n.status+" "+n.statusText)}},z=function(e){try{var t=$("<div/>").html(e).text().match(/(#?[\d.,]+\s+(in|em|en)\s+[^#Â°Âº}]+)/g),a=[];t&&(a=t),a=a.map((function(e){return e=(e=$.trim(e)).replace(/\s+/g," ")}));var n={};return a&&a[0]&&-1===a[0].indexOf(">")?(n.bsr=a[0],n.subrank=a.splice(1)):n.subrank=a,n}catch(e){return{}}},k=function(e,t,a){if(!e.match(/[Tt]op 100/)&&"www.amazon.com"===document.location.host){var n=$("<span>",{class:"xtaqv-bsr-sec"}).html('<img src="'+chrome.runtime.getURL("img/spinner16.gif")+'"/>').prependTo(t);v("https://www.amazon.com/gp/aw/d/"+a,!0,(function(e){if(n.text(""),e&&!e.error){var t,a=e.data,i=(new DOMParser).parseFromString(a,"text/html");if($("th.prodDetSectionEntry",i).map((function(e,a){"Best Sellers Rank"===$.trim(a.textContent)&&(t=parseInt($.trim($(a).next().text())))})),t){var r="#"+t.toLocaleString(),o=$("<span/>",{class:"extension-rank"}).text(r);n.html(o)}}}))}},S=function(a,n,i){$(n).find("script").remove(),t.html(n),i||(i="bottom");a.clientX,a.clientY;var r=window.innerWidth,o=document.documentElement.clientHeight,s=t.width();s<600&&(s=600);var l=a.toElement;l||(l=a.target);var d=l.getBoundingClientRect(),c=bottom=left=right="auto";left=d.left,r-left<s&&(right=0,left="auto"),"bottom"===i?c=d.top+d.height:bottom=o-d.top;var m={top:c,left:left,right:right,bottom:bottom};e.showTopRight&&(m={top:"5px",right:"5px",left:"auto",bottom:"auto"}),t.show().css(m)},P=function(e,t){for(var a,n=["#prodDetails","#detailBulletsWrapper_feature_div","#audibleProductDetails"],i="",r=0,o=n.length;r<o;r++){(a=$(n[r],e)[0])&&(i+=a.innerHTML)}return i||(console.log("Details not found: "+t),a=""),i},C=function(e,t){if(!e)return"";var a,n=(new DOMParser).parseFromString(e,"text/html"),i=$("#SalesRank",n),r=q(n);i[0]&&("TR"===i[0].tagName&&(i=i.find(".value")),a=i.html());var o=["Best Sellers Rank","Classement des meilleures ventes","Amazon Bestseller-Rang","Amazon Bestseller","Ranking dos mais vendidos","ClasificaciÃ³n en los mÃ¡s vendidos de Amazon","Posizione nella classifica Bestseller di Amazon","En Ãok Satanlar SÄ±ralamasÄ±","Plaats in bestsellerlijst","Rangordning fÃ¶r bÃ¤stsÃ¤ljare","Ranking najlepiej sprzedajÄcych siÄ produktÃ³w","äºé©¬éç­éååæå","Amazon å£²ãç­ã©ã³ã­ã³ã°","ØªØµÙÙÙ Ø§ÙØ£ÙØ¶Ù ÙØ¨ÙØ¹Ø§Ù"];if(!a)var s=$("th.prodDetSectionEntry",n).filter((function(){var e=$.trim(this.textContent),t=!1;o.map((function(a){-1!==e.indexOf(a)&&(t=!0)})),t&&(a=$(this).next().html())}));a||(s=$(".detail-bullet-list .a-list-item .a-text-bold",n).filter((function(){var e=$.trim(this.textContent);e=e.replace(":","");var t=!1;return o.map((function(a){-1!==e.indexOf(a)&&(t=!0)})),t})))[0]&&(a=s[0].parentNode.innerHTML,o.map((function(e){var t=new RegExp("\\s*"+e+":?\\s*","i");a=a.replace(t,"")})));if(!a){var l=$(".col2 .section.techD .pdTab b",n)[0];if(l){var d=$(l).closest(".section");d.find("table").remove(),d.find(".secHeader").remove(),a=$.trim(d.html())}}if(!a){var c=t.match(/<tr id="amazon-sales-rank-detail">[\s\S]*?<\/tr>/);if(c){n=(new DOMParser).parseFromString(c[0],"text/html");a=(a=n.body.innerHTML).replace(/\s*Best-sellers rank\s*/,"")}}return a||(a=""),{rankStr:a,details:r}},q=function(e){var t={},a=["Dimensions","Product Dimensions","Package Dimensions","Package dimensions","Item Package Dimensions L x W x H","åè£å°ºå¯¸","æ¢±åãµã¤ãº","Paket BoyutlarÄ±","Boyutlar","Produktens mÃ¥tt","Ø£Ø¨Ø¹Ø§Ø¯ Ø§ÙÙÙØªØ¬","Productafmetingen","Dimensioni","Dimensions du produit (L x l x h)","Dimensiones del producto","DimensÃµes do produto","DimensÃµes","Produktabmessungen","Dimensiones","Wymiary produktu","Wymiary opakowania","Wymiary"],n=["Item Weight","ååéé","Peso articolo","Poids de l'article","Peso del producto","Artikelgewicht"],i=["Date First Available","Amazon.cnä¸æ¶æ¶é´","çºå£²æ¥","ÃÄ±kÄ±Å tarihi","Utgivningsdatum","ØªØ§Ø±ÙØ® Ø§ÙØ¥ØµØ¯Ø§Ø±","Datum eerste beschikbaarheid","Publicatiedatum","Disponibile su Amazon.it a partire dal","Date de mise en ligne sur Amazon.fr","Producto en Amazon.es desde","Data de lanÃ§amento","Erscheinungstermin","Im Angebot von Amazon.de seit","Fecha de lanzamiento"],r=["Publisher","åºçç¤¾","YayÄ±ncÄ±","Utgivare","ØªØ§Ø±ÙØ® Ø§ÙØ¥ØµØ¯Ø§Ø±","Uitgever","Editore","Ãditeur","Editorial","Editora","Herausgeber","Wydawca"],o=["Pages","Paperback","Hardcover","çº¸ä¹¦é¡µæ°","KaÄÄ±t Kapak","ãã¼ãã«ãã¼","Ciltli Kapak","Pocketbok","Inbunden","ØºÙØ§Ù ÙØ±ÙÙ","Copertina flessibile","Cartonato","A fogli intercambiabili","BrochÃ©","Tapa blanda","Libro de cartÃ³n","Capa comum","Capa dura","Taschenbuch","Pasta blanda","Pasta dura","MiÄkka oprawa"],s=[];return $("th.prodDetSectionEntry",e).map((function(e,t){var a=$.trim(t.textContent),n=$.trim($(t).next().text());s.push([a,n])})),$(".detail-bullet-list .a-list-item .a-text-bold",e).map((function(e,t){var a=t.textContent.trim().replace(/\u200f/g,"").replace(/\u200e/g,"").replace(/\s*:\s*$/m,"").trim(),n=$.trim($(t).next().text());s.push([a,n])})),s.map((function(e){var s,l=e[0],d=e[1];-1!==a.indexOf(l)?s=a[0]:-1!==n.indexOf(l)?s=n[0]:-1!==i.indexOf(l)?s=i[0]:-1!==r.indexOf(l)?s=r[0]:-1!==o.indexOf(l)&&(s=o[0]),s&&(t[s.toLowerCase().replace(/ /g,"_")]=d)})),t.dimensions&&-1===t.dimensions.indexOf(";")&&t.item_weight&&(t.dimWeightStr=t.dimensions+"; "+t.item_weight),t},A=function(e,t){var a='<div class="xtaqv-ext-additional">';a+="<div>",e.dimWeightStr?a+=`<span>${e.dimWeightStr}</span>`:e.dimensions&&(a+=`<span>${e.dimensions}</span>`),e.date_first_available&&(a+=`<span>${e.date_first_available}</span>`),a+="</div>",e.publisher&&(a+="<div>",a+=`<span>${e.publisher}</span>`,e.pages&&(a+=`<span>${e.pages}</span>`),a+="</div>"),a+='<div>Copy title: <span href="#" class="xtaqv-copy" data-title="'+e.title.title6wordsEsc+'">6 words</span><span href="#" class="xtaqv-copy" data-title="'+e.title.titleEsc+'">all</span></div>',a+="</div>",t.find(".xtaqv-ext").append(a)},L=function(e){var t;$("#productOverview_feature_div table, table#product-specification-table",e).find("tr td:first-child, tr th:first-child").map((function(e,a){var n=$.trim(a.textContent);"Brand"!==n&&"Brand Name"!==n||(t=$.trim($(a).next().text()))})),t||$("#detailBullets_feature_div ul li",e).map((function(e,a){if(0===a.textContent.trim().indexOf("Manufacturer")){var n=a.querySelector(".a-list-item span:last-child");t=n.textContent.trim()}}));var a="",n=$("#bylineInfo",e),i=n.text();if(n[0]&&(a=n[0].href),!t&&a){var r=a.match(/\.amazon\..*?\/stores\/([^/]+)\//);r&&(t=r[1])}return t||0!==i.indexOf("Brand")||(t=i.replace("Brand: ","")),{url:a,name:t||"Brand"}},M=function(e,t){e&&e.name&&(e.url?$('<a data-badge="brand" href="'+e.url+'" target="_blank"/>').text(e.name):$('<span data-badge="brand" href=""/>').text(e.name)).insertAfter(t.find(".xtaqv-asin"))},T=function(t,a){if(e.showBBHolder){var n,i=!!$("#add-to-cart-button",t)[0],r=$.trim($("#merchant-info",t).text()),o=$("#tabular-buybox, #buybox-tabular",t);if(r)(r=r.split(/\.( |$)/)[0]).match(/(Ships|Dispatched) from and sold by Amazon/i)?'<span class="xtaqv-bb-amz">Amazon</span>':r.match(/Sold by .*? and Fulfilled by Amazon/i)?"FBA":r.match(/Ships from and sold by/)&&"3rd-party",n=r;else if(o[0]){var s=$.trim(o.find("#tabular-buybox-truncate-0 .a-truncate-full, #buyboxTabularTruncate-0 .a-truncate-full").text());s||(s=$.trim(o.find('.tabular-buybox-text[tabular-attribute-name="Ships from"]').text())),s||(s=$.trim(o.find('.tabular-buybox-text[tabular-attribute-name="Dispatches from"]').text())),s||(s=$.trim((o.find(".tabular-buybox-text[tabular-attribute-name]")[1]||{}).textContent));var l=$.trim(o.find("#tabular-buybox-truncate-1 .a-truncate-full, #buyboxTabularTruncate-1 .a-truncate-full").text());l||(l=$.trim(o.find('.tabular-buybox-text[tabular-attribute-name="Sold by"]').text())),l||(l=$.trim((o.find(".tabular-buybox-text[tabular-attribute-name]")[2]||{}).textContent)),s&&l||console.log("Investigate buyboxHolder",s,l),0===l.indexOf("Amazon")?'<span class="xtaqv-bb-amz">Amazon</span>':0===s.indexOf("Amazon")?"FBA":"3rd-party",n="Ships from "+s+", Sold by "+l}if(!i)$('<span data-badge="nobb"/>').text("No BuyBox").insertAfter(a.find(".xtaqv-asin"));var d=$("<div>",{class:"xtaqv-bb-holder"}).text(n);a.find(".xtaqv-ext").append(d)}},B=function(e,t){var a,n=D();return"price"===e?a=O(n,t):"bsr"===e?a=R(n,t):"bsr_static"===e&&(a=E(n,t)),"<div>"+a+"</div>"},D=function(){var e=document.location.hostname.replace(/(\w+\.)?amazon\./,"");return"com"===e?"us":e.replace("co.","").replace("com.","")},O=function(e,t){return'<img src="'+("https://charts.camelcamelcamel.com/"+e+"/"+t+"/amazon-new.png?force=1&zero=0&w=725&h=440&desired=false&legend=1&ilt=1&tp=all&fo=0&lang=en")+'"/>'},R=function(e,t){return"us"===e&&(e="com"),'<iframe src="'+x("chart",t)+'" width="960" height="450"/>'},E=function(e,t){return"us"===e&&(e="com"),'<img src="'+("https://dyn.keepa.com/pricehistory.png?asin="+t+"&domain="+e+"&width=725&height=440&amazon=0&range=365&salesrank=1")+'"/>'},I=function(e,t,a){var n=document.location.origin+"/gp/offer-listing/"+t+"/ref=dp_olp_new_mbc?ie=UTF8&condition=new",r=n;i&&(n=document.location.origin+"/gp/aod/ajax/ref=dp_aod_ALL_mbc?asin="+t+"&m=&pinnedofferhash=&qid=&smid=&sourcecustomerorglistid=&sourcecustomerorglistitemid=&sr="),v(n,a,(function(a){N(e,a,t,n,r)}))},N=function(e,t,a,n,r){if(t&&!t.error){var o=e.find(".xtaqv-root");if(Captcha.findHTML(t.data))return e.find(".xtaqv-ext").append("<span>CAPTCHA</span>"),o.data("captcha",!0),void Captcha.process(e,n);if(!o.data("offers-done")){o.data("offers-done",!0);var s,l=t.data,d=(new DOMParser).parseFromString(l,"text/html"),c="",m="";if((s=i?H(d):F(d)).amazon&&(m+='<a data-badge="soldbyamz" class="a-declarative" data-action="show-all-offers-display" data-show-all-offers-display=\'{"asin":"'+a+'"}\' href="'+r+'" target="_blank">Sold by Amazon</a>'),s.fbaSellersLen){var f=s.fbaSellersLen;s.hasMore&&(f+="+"),f='<a class="a-declarative" data-action="show-all-offers-display" data-show-all-offers-display=\'{"asin":"'+a+'"}\' href="'+r+'" target="_blank">'+(f+=" FBA Seller"+(parseInt(f)>1?"s":""))+"</a>",s.fbaMinPrice&&(f+=' <a class="xtaqv-fbamin" href="'+s.fbaSellerURL+'" target="_blank">'+s.fbaMinPrice+"</a>",s.diff>0&&s.diff<=.7&&(c="xtaqv-fbadiff")),m+=$("<span/>",{"data-badge":"fbasellers","data-val":s.fbaSellersLen,class:c}).html(f)[0].outerHTML}m&&($(m).appendTo(e.find(".xtaqv-ext")),j(e))}}},F=function(e){var t={},a=!!$('.olpSellerName img[alt^="Amazon"]',e)[0];if(!a)$(".olpSellerName img",e).map((function(e,t){var n=$(t).attr("src");n&&n.match(/01dXM-J1oeL\.gif/)&&(a=!0)}));a||$(".olpSellerName",e).map((function(e,t){"amazon.com"===$.trim(t.textContent).toLowerCase()&&(a=!0)}));var n=$(".olpDeliveryColumn .olpBadgeContainer",e),i=n.length,r="",o=!!$(".a-pagination",e).length;if(i){var s=$(n[0]).closest(".olpOffer"),l=s.find(".olpOfferPrice");if(r=s.find(".olpSellerName a")[0].href,l[0]){var d,c=$.trim(l[0].textContent),m=$($(".olpOffer",e)[0]).find(".olpOfferPrice")[0];d=m?$.trim(m.textContent):c;var f=(d=parseFloat(d.replace(/[^\d.]/g,"")))/parseFloat(c.replace(/[^\d.]/g,""));t.fbaMinPrice=c,t.fbaSellerURL=r,t.minPrice=d,t.diff=f}}return t.amazon=a,t.fbaSellersLen=i,t.hasMore=o,t},H=function(e){var t={amazon:!1,fbaSellersLen:0},a=$("input#aod-total-offer-count",e).val();a&&(a=parseInt(a));var n,i=[];return $("#aod-pinned-offer, #aod-offer-list .aod-information-block",e).map((function(e,a){var r=W(a);r.index=e,i.push(r),void 0===n&&(n=r.price,t.minPrice=n),"Amazon"!==r.name&&"Amazon Warehouse"!==r.name||(t.amazon=!0),r.fba&&(t.fbaSellersLen++,t.fbaSellerURL||(t.fbaSellerURL=r.sellerURL),t.fbaMinPrice||(t.fbaMinPrice=r.price),t.diff=n/t.fbaMinPrice)})),t.hasMore=a>i.length,t},W=function(e){var t={},a=$(e),n=a.find("#aod-offer-soldBy [role=link]")[0];if(n)t.name=$.trim(n.textContent),t.sellerURL=n,t.name.match(/^(return policy|RÃ¼cknahmerichtlinien)$/i)&&(n=$(n.parentNode).find("[aria-label]")[0])&&(t.name=$.trim(n.textContent));else{var i=a.find("#aod-offer-soldBy .a-col-right")[0];i&&-1!==$.trim(i.textContent).indexOf("Amazon")&&(t.name="Amazon")}return $.trim(a.find("#aod-offer-shipsFrom .a-col-right span").text()).match(/^amazon/i)&&0!==t.name.indexOf("Amazon")?t.fba=!0:t.fba=!1,t.price=$.trim(a.find(".a-price .a-offscreen").text()),t.price||(t.price=$.trim(a.find("[id^=aod-tax-incl-price]").text())),t.price=Helpers.convertPriceToNumber(t.price),t},U=function(){for(var e=AMZHelpers.getItems($("body")),t=0,a=e.length;t<a;t++){var n=e[t];j($(n))}},j=function(t){var a=!1;Filters.applyFiltersToItem(t)||(a=!0);var n=t.find(".xtaqv-root");if(t.find("[data-badge=soldbyamz]")[0]&&e.hideSoldByAmz&&(a=!0),t.find(".a-icon-prime, .a-icon-prime-pantry")[0]&&e.hidePrime&&(a=!0),t.find('[data-badge="nobb"]')[0]&&e.hideNoBB&&(a=!0),t.find(".s-sponsored-label-info-icon")[0]&&e.hideSponsored&&(a=!0),t.find(".puis-sponsored-label-text")[0]&&e.hideSponsored&&(a=!0),n.data("offers-done")){var i=t.find("[data-badge=fbasellers]").data("val");i||(i=0),e.filterFBASelMin>0&&i<e.filterFBASelMin&&(a=!0),e.filterFBASelMax>0&&i>e.filterFBASelMax&&(a=!0)}t.toggleClass("xtaqv-hidden",a)};return{init:function(){n=r(),o(),s(),chrome.runtime.sendMessage({cmd:"app.get_state"},(function(t){if(a=t.state,t.license,e=t.settings,a)if(t.visitTimestamp)try{c(),m()}catch(e){console.log(e)}else chrome.runtime.sendMessage({cmd:"gumroad.get",data:{key:e.license}},(function(e){if(!e.error)try{c(),m()}catch(e){console.log(e)}}));d(),l(),InfiniteScroll.init({onItemAdded:function(e){j(e)}})}))}}}();Module.init();